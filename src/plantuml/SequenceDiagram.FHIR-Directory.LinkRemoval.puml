@startuml SequenceDiagram.FHIR-Directory.linkRemoval
skinparam dpi 100
skinparam WrapWidth 200
skinparam monochrome true
autonumber "<b>[00]"

'title "FHIR-Directory, Sequenzdiagram link removal'
actor Nutzer
participant cl as "FHIR-VZD-Client"
box <size:16>FHIR-Directory</size> #WhiteSmoke
  participant fp as "FHIR-Proxy"
  participant fd as "FHIR-Directory"
  participant fa as "FHIR-VZD-Administration"
end box

Nutzer -> cl:Suche nach eigenen verlinkten Ressourcen
activate cl


group Lese alle eigenen verlinkten Rassourcen
  cl -> fp: GET /owner?... (Suche alle eigenen HealthcareService oder PractitionerRole \nmit telematikID aus dem accesstoken \noder clientID/holder aus dem accesstoken (Kartenherausgeber))
  activate fp
  fp -> fp: prüfe owner-accesstoken

    alt accesstoken is valid
      fp -> fd: GET /?...
      activate fd
      fd --> fp: HTTP 200 OK\n(Result Body json)
      deactivate fd
      fp --> cl: HTTP 200 OK (Result Body json)
     else search-accesstoken is invalid
      fp --> cl: HTTP 401
      deactivate fp
     end
end

cl --> Nutzer:Anzeige eigener, verlinkter Ressourcen 
Nutzer -> Nutzer: Auswahl der Verlinkungen, die gelöscht werden sollen
Nutzer -> cl: Lösche Verlinkungen \nmit selektierten Ressourcen

group VerlinkungsRemoval
  cl -> fa: deletePersonInstitutionLink {id}
  activate fa
  fa -> fa: prüfe owner-accesstoken

    alt accesstoken is valid \n& Verlinkung gehört zu eigener Ressource (telematikID/clientID/holder aus dem accesstoken)
      fa -> fa: Eintragen des Verlinkungsremovals
      fa -> fd: Löschen der Verlinkung in die FHIR Daten
      fd --> fa: HTTP 200 OK
      fa --> cl: HTTP 200 OK\n(Result Body json)
      
     else owner-accesstoken is invalid\noder Verlinkung bezieht sich nicht auf eigene Ressourcen/Zuständigkeitsbereich
      fa --> cl: HTTP 401
      deactivate fa
     end
end

cl -> Nutzer: Ergebnis Verlinkungsapproval

deactivate cl

@enduml
