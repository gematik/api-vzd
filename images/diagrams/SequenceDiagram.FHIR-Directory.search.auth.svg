<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentStyleType="text/css" height="563.5417px" preserveAspectRatio="none" style="width:1387px;height:563px;background:#FFFFFF;" version="1.1" viewBox="0 0 1387 563" width="1387.5px" zoomAndPan="magnify"><defs/><g><rect fill="#F5F5F5" height="551.6541" style="stroke:#181818;stroke-width:0.5208333333333334;" width="137.5" x="598.9583" y="6.25"/><text fill="#000000" font-family="sans-serif" font-size="16.6667" font-weight="bold" lengthAdjust="spacing" textLength="127.0833" x="602.0833" y="22.3633">FHIR-Directory</text><text fill="#000000" font-family="sans-serif" font-size="13.5417" font-weight="bold" lengthAdjust="spacing" textLength="4.1667" x="729.1667" y="23.0225">Â </text><rect fill="#FFFFFF" height="412.7909" style="stroke:#181818;stroke-width:1.0416666666666667;" width="10.4167" x="216.1458" y="73.2625"/><rect fill="#FFFFFF" height="243.5364" style="stroke:#181818;stroke-width:1.0416666666666667;" width="10.4167" x="662.5" y="242.5171"/><rect fill="#FFFFFF" height="73.528" style="stroke:#181818;stroke-width:1.0416666666666667;" width="10.4167" x="1299.4792" y="122.5087"/><rect fill="#FFFFFF" height="46.4803" style="stroke:#181818;stroke-width:1.0416666666666667;" width="10.4167" x="1299.4792" y="333.0709"/><line style="stroke:#181818;stroke-width:0.5208333333333334;stroke-dasharray:5.0,5.0;" x1="220.8333" x2="220.8333" y1="62.8459" y2="504.8035"/><line style="stroke:#181818;stroke-width:0.5208333333333334;stroke-dasharray:5.0,5.0;" x1="667.1875" x2="667.1875" y1="62.8459" y2="504.8035"/><line style="stroke:#181818;stroke-width:0.5208333333333334;stroke-dasharray:5.0,5.0;" x1="1304.6875" x2="1304.6875" y1="62.8459" y2="504.8035"/><rect fill="#E3E3E3" height="31.7586" rx="2.6042" ry="2.6042" style="stroke:#181818;stroke-width:0.5208333333333334;" width="163.5417" x="139.5833" y="30.0456"/><text fill="#000000" font-family="sans-serif" font-size="14.5833" lengthAdjust="spacing" textLength="148.9583" x="146.875" y="51.4364">TI-Messenger-Client</text><rect fill="#E3E3E3" height="31.7586" rx="2.6042" ry="2.6042" style="stroke:#181818;stroke-width:0.5208333333333334;" width="163.5417" x="139.5833" y="503.7618"/><text fill="#000000" font-family="sans-serif" font-size="14.5833" lengthAdjust="spacing" textLength="148.9583" x="146.875" y="525.1526">TI-Messenger-Client</text><rect fill="#E3E3E3" height="31.7586" rx="2.6042" ry="2.6042" style="stroke:#181818;stroke-width:0.5208333333333334;" width="107.2917" x="614.0625" y="30.0456"/><text fill="#000000" font-family="sans-serif" font-size="14.5833" lengthAdjust="spacing" textLength="92.7083" x="621.3542" y="51.4364">Auth-Service</text><rect fill="#E3E3E3" height="31.7586" rx="2.6042" ry="2.6042" style="stroke:#181818;stroke-width:0.5208333333333334;" width="107.2917" x="614.0625" y="503.7618"/><text fill="#000000" font-family="sans-serif" font-size="14.5833" lengthAdjust="spacing" textLength="92.7083" x="621.3542" y="525.1526">Auth-Service</text><rect fill="#E3E3E3" height="48.9339" rx="2.6042" ry="2.6042" style="stroke:#181818;stroke-width:0.5208333333333334;" width="154.1667" x="1227.6042" y="12.8703"/><text fill="#000000" font-family="sans-serif" font-size="14.5833" lengthAdjust="spacing" textLength="139.5833" x="1234.8958" y="34.2611">Matrix-Homeserver</text><text fill="#000000" font-family="sans-serif" font-size="14.5833" lengthAdjust="spacing" textLength="136.4583" x="1236.4583" y="51.4364">(Messenger-Proxy)</text><rect fill="#E3E3E3" height="48.9339" rx="2.6042" ry="2.6042" style="stroke:#181818;stroke-width:0.5208333333333334;" width="154.1667" x="1227.6042" y="503.7618"/><text fill="#000000" font-family="sans-serif" font-size="14.5833" lengthAdjust="spacing" textLength="139.5833" x="1234.8958" y="525.1526">Matrix-Homeserver</text><text fill="#000000" font-family="sans-serif" font-size="14.5833" lengthAdjust="spacing" textLength="136.4583" x="1236.4583" y="542.3279">(Messenger-Proxy)</text><rect fill="#FFFFFF" height="412.7909" style="stroke:#181818;stroke-width:1.0416666666666667;" width="10.4167" x="216.1458" y="73.2625"/><rect fill="#FFFFFF" height="243.5364" style="stroke:#181818;stroke-width:1.0416666666666667;" width="10.4167" x="662.5" y="242.5171"/><rect fill="#FFFFFF" height="73.528" style="stroke:#181818;stroke-width:1.0416666666666667;" width="10.4167" x="1299.4792" y="122.5087"/><rect fill="#FFFFFF" height="46.4803" style="stroke:#181818;stroke-width:1.0416666666666667;" width="10.4167" x="1299.4792" y="333.0709"/><polygon fill="#181818" points="1286.9792,118.3421,1297.3958,122.5087,1286.9792,126.6754,1291.1458,122.5087" style="stroke:#181818;stroke-width:1.0416666666666667;"/><line style="stroke:#181818;stroke-width:1.0416666666666667;" x1="226.5625" x2="1293.2292" y1="122.5087" y2="122.5087"/><text fill="#000000" font-family="sans-serif" font-size="13.5417" lengthAdjust="spacing" textLength="406.25" x="233.8542" y="117.569">POST /_matrix/client/v3/user/{userId}/openid/request_token</text><path d="M5.2083,78.4709 L5.2083,152.4292 L211.4583,152.4292 L211.4583,88.8875 L201.0417,78.4709 L5.2083,78.4709 " fill="#FAFAFA" style="stroke:#181818;stroke-width:0.5208333333333334;"/><path d="M201.0417,78.4709 L201.0417,88.8875 L211.4583,88.8875 L201.0417,78.4709 " fill="#FAFAFA" style="stroke:#181818;stroke-width:0.5208333333333334;"/><text fill="#000000" font-family="sans-serif" font-size="13.5417" lengthAdjust="spacing" textLength="86.4583" x="11.4583" y="96.7712">Precondition:</text><text fill="#000000" font-family="sans-serif" font-size="13.5417" lengthAdjust="spacing" textLength="171.875" x="11.4583" y="112.7197">The user is logged in &amp; no</text><text fill="#000000" font-family="sans-serif" font-size="13.5417" lengthAdjust="spacing" textLength="180.2083" x="11.4583" y="128.6682">search-accesstoken for the</text><text fill="#000000" font-family="sans-serif" font-size="13.5417" lengthAdjust="spacing" textLength="142.7083" x="11.4583" y="144.6167">FHIR-Directory exists</text><polygon fill="#181818" points="238.0208,191.8701,227.6042,196.0368,238.0208,200.2035,233.8542,196.0368" style="stroke:#181818;stroke-width:1.0416666666666667;"/><line style="stroke:#181818;stroke-width:1.0416666666666667;stroke-dasharray:2.0,2.0;" x1="231.7708" x2="1303.6458" y1="196.0368" y2="196.0368"/><text fill="#000000" font-family="sans-serif" font-size="13.5417" lengthAdjust="spacing" textLength="492.7083" x="244.2708" y="175.1485">HTTP 200 OK, Result body {"access_token": "OFdZNozDIomXLrCWjgejIQBM"</text><text fill="#000000" font-family="sans-serif" font-size="13.5417" lengthAdjust="spacing" textLength="337.5" x="248.4375" y="191.097">,..., "matrix_server_name": "matrix.service-ti.de",...}</text><polygon fill="#181818" points="650,238.3504,660.4167,242.5171,650,246.6838,654.1667,242.5171" style="stroke:#181818;stroke-width:1.0416666666666667;"/><line style="stroke:#181818;stroke-width:1.0416666666666667;" x1="226.5625" x2="656.25" y1="242.5171" y2="242.5171"/><text fill="#000000" font-family="sans-serif" font-size="13.5417" lengthAdjust="spacing" textLength="332.2917" x="233.8542" y="221.6288">GET /tim-authenticate?mxId=matrix.service-ti.de"</text><text fill="#000000" font-family="sans-serif" font-size="13.5417" lengthAdjust="spacing" textLength="401.0417" x="238.0208" y="237.5773">-H "X-Matrix-OpenID-Token: OFdZNozDIomXLrCWjgejIQBM"</text><line style="stroke:#181818;stroke-width:1.0416666666666667;" x1="672.9167" x2="716.6667" y1="288.9974" y2="288.9974"/><line style="stroke:#181818;stroke-width:1.0416666666666667;" x1="716.6667" x2="716.6667" y1="288.9974" y2="302.5391"/><line style="stroke:#181818;stroke-width:1.0416666666666667;" x1="673.9583" x2="716.6667" y1="302.5391" y2="302.5391"/><polygon fill="#181818" points="684.375,298.3724,673.9583,302.5391,684.375,306.7057,680.2083,302.5391" style="stroke:#181818;stroke-width:1.0416666666666667;"/><text fill="#000000" font-family="sans-serif" font-size="13.5417" lengthAdjust="spacing" textLength="306.25" x="680.2083" y="268.1091">Check that matrix server "matrix.service-ti.de"</text><text fill="#000000" font-family="sans-serif" font-size="13.5417" lengthAdjust="spacing" textLength="180.2083" x="684.375" y="284.0576">is part of the federation list</text><polygon fill="#181818" points="1286.9792,328.9042,1297.3958,333.0709,1286.9792,337.2375,1291.1458,333.0709" style="stroke:#181818;stroke-width:1.0416666666666667;"/><line style="stroke:#181818;stroke-width:1.0416666666666667;" x1="672.9167" x2="1293.2292" y1="333.0709" y2="333.0709"/><text fill="#000000" font-family="sans-serif" font-size="13.5417" lengthAdjust="spacing" textLength="595.8333" x="680.2083" y="328.1311">GET /_matrix/federation/v1/openid/userinfo?access_token=OFdZNozDIomXLrCWjgejIQBM</text><polygon fill="#181818" points="684.375,375.3845,673.9583,379.5512,684.375,383.7179,680.2083,379.5512" style="stroke:#181818;stroke-width:1.0416666666666667;"/><line style="stroke:#181818;stroke-width:1.0416666666666667;stroke-dasharray:2.0,2.0;" x1="678.125" x2="1303.6458" y1="379.5512" y2="379.5512"/><text fill="#000000" font-family="sans-serif" font-size="13.5417" lengthAdjust="spacing" textLength="86.4583" x="690.625" y="358.6629">HTTP 200 OK</text><text fill="#000000" font-family="sans-serif" font-size="13.5417" lengthAdjust="spacing" textLength="340.625" x="690.625" y="374.6114">Result Body {"sub": "@testuser:matrix.service-ti.de"}</text><line style="stroke:#181818;stroke-width:1.0416666666666667;" x1="672.9167" x2="716.6667" y1="410.083" y2="410.083"/><line style="stroke:#181818;stroke-width:1.0416666666666667;" x1="716.6667" x2="716.6667" y1="410.083" y2="423.6247"/><line style="stroke:#181818;stroke-width:1.0416666666666667;" x1="673.9583" x2="716.6667" y1="423.6247" y2="423.6247"/><polygon fill="#181818" points="684.375,419.458,673.9583,423.6247,684.375,427.7913,680.2083,423.6247" style="stroke:#181818;stroke-width:1.0416666666666667;"/><text fill="#000000" font-family="sans-serif" font-size="13.5417" lengthAdjust="spacing" textLength="342.7083" x="680.2083" y="405.1432">Create search-accesstoken for TI-Messenger-Client</text><polygon fill="#181818" points="232.8125,481.8868,222.3958,486.0535,232.8125,490.2201,228.6458,486.0535" style="stroke:#181818;stroke-width:1.0416666666666667;"/><line style="stroke:#181818;stroke-width:1.0416666666666667;stroke-dasharray:2.0,2.0;" x1="226.5625" x2="666.6667" y1="486.0535" y2="486.0535"/><text fill="#000000" font-family="sans-serif" font-size="13.5417" lengthAdjust="spacing" textLength="171.875" x="239.0625" y="449.2167">HTTP 200 OK, Result body</text><text fill="#000000" font-family="sans-serif" font-size="13.5417" lengthAdjust="spacing" textLength="387.5" x="239.0625" y="465.1652">{"access_token"="eyJ0eXAiOiJKV1...", "token_type":"bearer",</text><text fill="#000000" font-family="sans-serif" font-size="13.5417" lengthAdjust="spacing" textLength="128.125" x="239.0625" y="481.1137">"expires_in":86400}</text><!--MD5=[7426421b06219b2a99e18ad499afea06]
@startuml SequenceDiagram.FHIR-Directory.search.auth
skinparam dpi 100
skinparam WrapWidth 200
skinparam monochrome true

'title "FHIR-Directory, Sequenzdiagram search token exchange'
participant cl as "TI-Messenger-Client"
box <size:16>FHIR-Directory</size> #WhiteSmoke
  participant au as "Auth-Service"
end box
participant hs as "Matrix-Homeserver\n(Messenger-Proxy)"
activate cl
cl -> hs: POST /_matrix/client/v3/user/{userId}/openid/request_token
note left
Precondition: 
The user is logged in & no search-accesstoken for the FHIR-Directory exists
end note
activate hs
hs - -> cl: HTTP 200 OK, Result body {"access_token": "OFdZNozDIomXLrCWjgejIQBM" \n ,..., "matrix_server_name": "matrix.service-ti.de",...}
deactivate hs
cl -> au: GET /tim-authenticate?mxId=matrix.service-ti.de" \n -H "X-Matrix-OpenID-Token: OFdZNozDIomXLrCWjgejIQBM"
activate au
au -> au: Check that matrix server "matrix.service-ti.de"\n is part of the federation list
au -> hs: GET /_matrix/federation/v1/openid/userinfo?access_token=OFdZNozDIomXLrCWjgejIQBM
activate hs
hs - -> au: HTTP 200 OK\nResult Body {"sub": "@testuser:matrix.service-ti.de"}
deactivate hs
au -> au: Create search-accesstoken for TI-Messenger-Client
au - -> cl: HTTP 200 OK, Result body\n{"access_token"="eyJ0eXAiOiJKV1...", "token_type":"bearer",\n"expires_in":86400}
deactivate au
deactivate cl
@enduml

@startuml SequenceDiagram.FHIR-Directory.search.auth
skinparam dpi 100
skinparam WrapWidth 200
skinparam monochrome true

participant cl as "TI-Messenger-Client"
box <size:16>FHIR-Directory</size> #WhiteSmoke
  participant au as "Auth-Service"
end box
participant hs as "Matrix-Homeserver\n(Messenger-Proxy)"
activate cl
cl -> hs: POST /_matrix/client/v3/user/{userId}/openid/request_token
note left
Precondition: 
The user is logged in & no search-accesstoken for the FHIR-Directory exists
end note
activate hs
hs - -> cl: HTTP 200 OK, Result body {"access_token": "OFdZNozDIomXLrCWjgejIQBM" \n ,..., "matrix_server_name": "matrix.service-ti.de",...}
deactivate hs
cl -> au: GET /tim-authenticate?mxId=matrix.service-ti.de" \n -H "X-Matrix-OpenID-Token: OFdZNozDIomXLrCWjgejIQBM"
activate au
au -> au: Check that matrix server "matrix.service-ti.de"\n is part of the federation list
au -> hs: GET /_matrix/federation/v1/openid/userinfo?access_token=OFdZNozDIomXLrCWjgejIQBM
activate hs
hs - -> au: HTTP 200 OK\nResult Body {"sub": "@testuser:matrix.service-ti.de"}
deactivate hs
au -> au: Create search-accesstoken for TI-Messenger-Client
au - -> cl: HTTP 200 OK, Result body\n{"access_token"="eyJ0eXAiOiJKV1...", "token_type":"bearer",\n"expires_in":86400}
deactivate au
deactivate cl
@enduml

PlantUML version 1.2022.7(Mon Aug 22 19:01:30 CEST 2022)
(GPL source distribution)
Java Runtime: OpenJDK Runtime Environment
JVM: OpenJDK 64-Bit Server VM
Default Encoding: UTF-8
Language: de
Country: DE
--></g></svg>