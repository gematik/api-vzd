<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentStyleType="text/css" height="1819px" preserveAspectRatio="none" style="width:1850px;height:1819px;background:#FFFFFF;" version="1.1" viewBox="0 0 1850 1819" width="1850px" zoomAndPan="magnify"><defs/><g><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacing" textLength="304" x="769" y="27.9951">Entkoppelte FHIR-VZD Authentisierung</text><rect fill="#F5F5F5" height="1770.5703" style="stroke:#181818;stroke-width:0.5;" width="153" x="1160.5" y="43.2969"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="142" x="1163.5" y="55.3638">VZD-FHIR-Directory</text><rect fill="#FFFFFF" height="1524.7109" style="stroke:#181818;stroke-width:1.0;" width="10" x="261" y="149.7266"/><rect fill="#FFFFFF" height="299.7266" style="stroke:#181818;stroke-width:1.0;" width="10" x="528" y="743.8438"/><rect fill="#FFFFFF" height="44.2656" style="stroke:#181818;stroke-width:1.0;" width="10" x="921" y="818.375"/><rect fill="#FFFFFF" height="39.6992" style="stroke:#181818;stroke-width:1.0;" width="10" x="921" y="1105.4023"/><rect fill="#FFFFFF" height="1450.1797" style="stroke:#181818;stroke-width:1.0;" width="10" x="1232" y="224.2578"/><rect fill="none" height="1029.3906" style="stroke:#000000;stroke-width:1.5;" width="1654" x="10" y="645.0469"/><rect fill="none" height="303.4688" style="stroke:#000000;stroke-width:1.5;" width="1277.5" x="20" y="1363.9688"/><line style="stroke:#181818;stroke-width:0.5;stroke-dasharray:5.0,5.0;" x1="85" x2="85" y1="118.5938" y2="1734.5703"/><line style="stroke:#181818;stroke-width:0.5;stroke-dasharray:5.0,5.0;" x1="266" x2="266" y1="118.5938" y2="1734.5703"/><line style="stroke:#181818;stroke-width:0.5;stroke-dasharray:5.0,5.0;" x1="533" x2="533" y1="118.5938" y2="1734.5703"/><line style="stroke:#181818;stroke-width:0.5;stroke-dasharray:5.0,5.0;" x1="926" x2="926" y1="118.5938" y2="1734.5703"/><line style="stroke:#181818;stroke-width:0.5;stroke-dasharray:5.0,5.0;" x1="1236.5" x2="1236.5" y1="118.5938" y2="1734.5703"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="130" x="17" y="115.292">Leistungserbringer</text><ellipse cx="85" cy="50.7969" fill="#E2E2F0" rx="8" ry="8" style="stroke:#181818;stroke-width:0.5;"/><path d="M85,58.7969 L85,85.7969 M72,66.7969 L98,66.7969 M85,85.7969 L72,100.7969 M85,85.7969 L98,100.7969 " fill="none" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="130" x="17" y="1746.5654">Leistungserbringer</text><ellipse cx="85" cy="1758.3672" fill="#E2E2F0" rx="8" ry="8" style="stroke:#181818;stroke-width:0.5;"/><path d="M85,1766.3672 L85,1793.3672 M72,1774.3672 L98,1774.3672 M85,1793.3672 L72,1808.3672 M85,1793.3672 L98,1808.3672 " fill="none" style="stroke:#181818;stroke-width:0.5;"/><rect fill="#E2E2F0" height="30.2969" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="86" x="223" y="87.2969"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="72" x="230" y="107.292">TI-M Client</text><rect fill="#E2E2F0" height="30.2969" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="86" x="223" y="1733.5703"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="72" x="230" y="1753.5654">TI-M Client</text><rect fill="#E2E2F0" height="30.2969" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="166" x="450" y="87.2969"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="152" x="457" y="107.292">gematik Authenticator</text><rect fill="#E2E2F0" height="30.2969" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="166" x="450" y="1733.5703"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="152" x="457" y="1753.5654">gematik Authenticator</text><rect fill="#E2E2F0" height="30.2969" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="146" x="853" y="87.2969"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="132" x="860" y="107.292">gematik IDP-Dienst</text><rect fill="#E2E2F0" height="30.2969" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="146" x="853" y="1733.5703"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="132" x="860" y="1753.5654">gematik IDP-Dienst</text><rect fill="#E2E2F0" height="30.2969" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="101" x="1186.5" y="87.2969"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="87" x="1193.5" y="107.292">Auth-Service</text><rect fill="#E2E2F0" height="30.2969" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="101" x="1186.5" y="1733.5703"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="87" x="1193.5" y="1753.5654">Auth-Service</text><rect fill="#FFFFFF" height="1524.7109" style="stroke:#181818;stroke-width:1.0;" width="10" x="261" y="149.7266"/><rect fill="#FFFFFF" height="299.7266" style="stroke:#181818;stroke-width:1.0;" width="10" x="528" y="743.8438"/><rect fill="#FFFFFF" height="44.2656" style="stroke:#181818;stroke-width:1.0;" width="10" x="921" y="818.375"/><rect fill="#FFFFFF" height="39.6992" style="stroke:#181818;stroke-width:1.0;" width="10" x="921" y="1105.4023"/><rect fill="#FFFFFF" height="1450.1797" style="stroke:#181818;stroke-width:1.0;" width="10" x="1232" y="224.2578"/><polygon fill="#181818" points="249,145.7266,259,149.7266,249,153.7266,253,149.7266" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="85" x2="255" y1="149.7266" y2="149.7266"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="30" x="92" y="144.6606">[01]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="123" x="126" y="144.6606">Anmeldung starten</text><polygon fill="#181818" points="1220,220.2578,1230,224.2578,1220,228.2578,1224,224.2578" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="271" x2="1226" y1="224.2578" y2="224.2578"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="30" x="278" y="196.4927">[02]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="213" x="312" y="173.7935">Decoupled Authorization Request</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="237" x="312" y="188.9263">POST /owner-authenticate-decoupled</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="375" x="312" y="204.0591">Header: Content-Type=application/x-www-form-urlencoded</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="399" x="312" y="219.1919">Body: grant_type=urn:telematik:params:grant-type:decoupled</text><line style="stroke:#181818;stroke-width:1.0;" x1="1242" x2="1284" y1="253.3906" y2="253.3906"/><line style="stroke:#181818;stroke-width:1.0;" x1="1284" x2="1284" y1="253.3906" y2="266.3906"/><line style="stroke:#181818;stroke-width:1.0;" x1="1243" x2="1284" y1="266.3906" y2="266.3906"/><polygon fill="#181818" points="1253,262.3906,1243,266.3906,1253,270.3906,1249,266.3906" style="stroke:#181818;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="30" x="1249" y="248.3247">[03]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="389" x="1283" y="248.3247">Erzeuge PKCE_code_challenge, PKCE_code_verifier und state</text><line style="stroke:#181818;stroke-width:1.0;" x1="1242" x2="1284" y1="307.1563" y2="307.1563"/><line style="stroke:#181818;stroke-width:1.0;" x1="1284" x2="1284" y1="307.1563" y2="320.1563"/><line style="stroke:#181818;stroke-width:1.0;" x1="1243" x2="1284" y1="320.1563" y2="320.1563"/><polygon fill="#181818" points="1253,316.1563,1243,320.1563,1253,324.1563,1249,320.1563" style="stroke:#181818;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="30" x="1249" y="302.0903">[04]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="131" x="1283" y="302.0903">Erzeuge auth_req_id</text><path d="M1426,279.3906 L1426,334.3906 L1828,334.3906 L1828,289.3906 L1818,279.3906 L1426,279.3906 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><path d="M1818,279.3906 L1818,289.3906 L1828,289.3906 L1818,279.3906 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="152" x="1432" y="296.4575">Siehe Bildungsregel:</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="381" x="1432" y="311.5903">https://openid.net/specs/openid-client-initiated-backchannel</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="292" x="1432" y="326.7231">-authentication-core-1_0.html#rfc.section.7.3</text><line style="stroke:#181818;stroke-width:1.0;" x1="1242" x2="1284" y1="376.0547" y2="376.0547"/><line style="stroke:#181818;stroke-width:1.0;" x1="1284" x2="1284" y1="376.0547" y2="389.0547"/><line style="stroke:#181818;stroke-width:1.0;" x1="1243" x2="1284" y1="389.0547" y2="389.0547"/><polygon fill="#181818" points="1253,385.0547,1243,389.0547,1253,393.0547,1249,389.0547" style="stroke:#181818;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="30" x="1249" y="363.4224">[05]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="393" x="1283" y="355.856">code, state und auth_req_id werden als Autorisierungsauftrag</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="241" x="1287" y="370.9888">in einem persistent Store gespeichert</text><polygon fill="#181818" points="282,626.0469,272,630.0469,282,634.0469,278,630.0469" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="276" x2="1231" y1="630.0469" y2="630.0469"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="30" x="288" y="519.0513">[06]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="273" x="322" y="413.1216">Decoupled Authorization Response 200 OK</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="5" x="322" y="428.2544">(</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="119" x="354" y="443.3872">"auth_req_id": "...",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="89" x="354" y="458.52">"poll_uri": "...",</text><text fill="#000000" font-family="sans-serif" font-size="13" font-style="italic" lengthAdjust="spacing" textLength="88" x="354" y="473.6528">{redirect_uri}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="251" x="442" y="473.6528">: "https://idp-ref.app.ti-dienste.de/auth?</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="136" x="386" y="488.7856">response_type=code</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="236" x="386" y="503.9185">&amp;client_id=GEMgematFHI4HkPrd8SR</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="161" x="386" y="519.0513">&amp;scope=fhir-vzd+openid</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="612" x="386" y="534.1841">&amp;redirect_uri=https%3A%2F%2Ffhir-directory-ref.vzd.ti-dienste.de%2Fsignin-gematik-idp-dienst</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="235" x="386" y="549.3169">&amp;state=HkX8By1qMekEg4a7B1aXyw</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="464" x="386" y="564.4497">&amp;code_challenge=a0kY3HugNKgveqhBQjc1tmX4_m-OT7FMF175rDlOIOM</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="220" x="386" y="579.5825">&amp;code_challenge_method=S256",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="110" x="358" y="594.7153">"expires_in": 600,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="73" x="358" y="609.8481">"interval": 3</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="5" x="322" y="624.981">)</text><path d="M10,645.0469 L80,645.0469 L80,652.1797 L70,662.1797 L10,662.1797 L10,645.0469 " fill="#EEEEEE" style="stroke:#000000;stroke-width:1.5;"/><rect fill="none" height="1029.3906" style="stroke:#000000;stroke-width:1.5;" width="1654" x="10" y="645.0469"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="25" x="25" y="658.1138">par</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="132" x="95" y="657.2573">[Authenticator Flow]</text><polygon fill="#181818" points="516,739.8438,526,743.8438,516,747.8438,520,743.8438" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="271" x2="522" y1="743.8438" y2="743.8438"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="30" x="278" y="708.5122">[07]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="102" x="312" y="678.2466">Deeplink-Aufruf:</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="105" x="312" y="693.3794">authenticator://?</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="108" x="320" y="708.5122">challenge_path=</text><text fill="#000000" font-family="sans-serif" font-size="13" font-style="italic" lengthAdjust="spacing" textLength="88" x="428" y="708.5122">{redirect_uri}</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="135" x="344" y="723.645">&amp;callback=DIRECT</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="121" x="344" y="738.7778">&amp;cardType=HBA</text><polygon fill="#181818" points="549,814.375,539,818.375,549,822.375,545,818.375" style="stroke:#181818;stroke-width:1.0;"/><polygon fill="#181818" points="909,814.375,919,818.375,909,822.375,913,818.375" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="543" x2="915" y1="818.375" y2="818.375"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="30" x="555" y="790.6099">[08]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="267" x="589" y="767.9106">Der Authenticator interagiert mit dem IDP</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="301" x="593" y="783.0435">und über einen Konnektor mit den Smartcards.</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="311" x="589" y="798.1763">Am Ende des Prozesses erhält der Authenticator</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="156" x="593" y="813.3091">den auth_code vom IDP.</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="166" x="753" y="813.3091">Siehe nächster Aufruf!</text><polygon fill="#181818" points="549,858.6406,539,862.6406,549,866.6406,545,862.6406" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="543" x2="925" y1="862.6406" y2="862.6406"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="30" x="555" y="850.0083">[09]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="296" x="589" y="842.4419">302 Redirect auf die redirect_uri des VZD-FHIR</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="223" x="593" y="857.5747">mit dem auth_code und dem state</text><polygon fill="#181818" points="1220,918.0391,1230,922.0391,1220,926.0391,1224,922.0391" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="538" x2="1226" y1="922.0391" y2="922.0391"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="30" x="545" y="901.8403">[10]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="318" x="579" y="886.7075">Der Authenticator ruft selbst mit einem HTTP Get,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="253" x="579" y="901.8403">redirect_uri&amp;code=XXX&amp;state=YYY auf.</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="5" x="579" y="916.9731">)</text><line style="stroke:#181818;stroke-width:1.0;" x1="1242" x2="1284" y1="966.3047" y2="966.3047"/><line style="stroke:#181818;stroke-width:1.0;" x1="1284" x2="1284" y1="966.3047" y2="979.3047"/><line style="stroke:#181818;stroke-width:1.0;" x1="1243" x2="1284" y1="979.3047" y2="979.3047"/><polygon fill="#181818" points="1253,975.3047,1243,979.3047,1253,983.3047,1249,979.3047" style="stroke:#181818;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="30" x="1249" y="953.6724">[11]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="263" x="1283" y="946.106">Finde via state den Autorisierungsauftrag</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="369" x="1283" y="961.2388">und speichere auth_code in diesem Autorisierungsauftrag</text><polygon fill="#181818" points="549,1004.4375,539,1008.4375,549,1012.4375,545,1008.4375" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="543" x2="1231" y1="1008.4375" y2="1008.4375"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="30" x="555" y="1003.3716">[12]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="131" x="589" y="1003.3716">200 OK, Empty Body</text><line style="stroke:#181818;stroke-width:1.0;" x1="538" x2="580" y1="1042.5703" y2="1042.5703"/><line style="stroke:#181818;stroke-width:1.0;" x1="580" x2="580" y1="1042.5703" y2="1055.5703"/><line style="stroke:#181818;stroke-width:1.0;" x1="533" x2="580" y1="1055.5703" y2="1055.5703"/><polygon fill="#181818" points="543,1051.5703,533,1055.5703,543,1059.5703,539,1055.5703" style="stroke:#181818;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="30" x="545" y="1037.5044">[13]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="160" x="579" y="1037.5044">Anwendung wird beendet</text><polygon fill="#181818" points="942,1101.4023,932,1105.4023,942,1109.4023,938,1105.4023" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="936" x2="1231" y1="1105.4023" y2="1105.4023"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="30" x="948" y="1092.77">[14]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="216" x="982" y="1085.2036">Übergabe des auth_code und des</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="226" x="982" y="1100.3364">key_verifier an den Token Endpunkt</text><path d="M470,1063.5703 L470,1118.5703 L916,1118.5703 L916,1073.5703 L906,1063.5703 L470,1063.5703 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><path d="M906,1063.5703 L906,1073.5703 L916,1073.5703 L906,1063.5703 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="45" x="476" y="1080.6372">Siehe:</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="416" x="476" y="1095.77">https://github.com/gematik/api-ti-messenger/blob/main/docs/IDP/</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="425" x="476" y="1110.9028">idp.adoc#3231-erzeugung-des-key_verifier-durch-die-relying-party</text><polygon fill="#181818" points="1220,1141.1016,1230,1145.1016,1220,1149.1016,1224,1145.1016" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="926" x2="1226" y1="1145.1016" y2="1145.1016"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="30" x="933" y="1140.0356">[15]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="118" x="967" y="1140.0356">signierter id_token</text><line style="stroke:#181818;stroke-width:1.0;" x1="1242" x2="1284" y1="1189.3672" y2="1189.3672"/><line style="stroke:#181818;stroke-width:1.0;" x1="1284" x2="1284" y1="1189.3672" y2="1202.3672"/><line style="stroke:#181818;stroke-width:1.0;" x1="1243" x2="1284" y1="1202.3672" y2="1202.3672"/><polygon fill="#181818" points="1253,1198.3672,1243,1202.3672,1253,1206.3672,1249,1202.3672" style="stroke:#181818;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="30" x="1249" y="1176.7349">[16]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="333" x="1283" y="1169.1685">Erzeuge owner-accesstoken auf Basis des id_tokens</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="302" x="1283" y="1184.3013">und speichere dieses am Autorisierungsauftrag</text><line style="stroke:#000000;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="10" x2="1664" y1="1211.3672" y2="1211.3672"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="113" x="15" y="1221.5776">[TI-M Client pollt]</text><polygon fill="#181818" points="1220,1272.5703,1230,1276.5703,1220,1280.5703,1224,1276.5703" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="271" x2="1226" y1="1276.5703" y2="1276.5703"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="30" x="278" y="1256.3716">[17]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="246" x="312" y="1241.2388">Access Token Request POST {poll_uri}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="242" x="312" y="1256.3716">aus Decopled Authorization Response</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="217" x="312" y="1271.5044">Body: auth_req_id={auth_req_id}</text><line style="stroke:#181818;stroke-width:1.0;" x1="1242" x2="1284" y1="1335.9688" y2="1335.9688"/><line style="stroke:#181818;stroke-width:1.0;" x1="1284" x2="1284" y1="1335.9688" y2="1348.9688"/><line style="stroke:#181818;stroke-width:1.0;" x1="1243" x2="1284" y1="1348.9688" y2="1348.9688"/><polygon fill="#181818" points="1253,1344.9688,1243,1348.9688,1253,1352.9688,1249,1348.9688" style="stroke:#181818;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="30" x="1249" y="1315.77">[18]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="257" x="1283" y="1300.6372">Prüfe ob für die übergebene auth_req_id</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="240" x="1287" y="1315.77">ein Autorisierungsauftrag vorliegt und</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="222" x="1283" y="1330.9028">ggf. bereits ein owner-accesstoken</text><path d="M20,1363.9688 L84,1363.9688 L84,1371.1016 L74,1381.1016 L20,1381.1016 L20,1363.9688 " fill="#EEEEEE" style="stroke:#000000;stroke-width:1.5;"/><rect fill="none" height="303.4688" style="stroke:#000000;stroke-width:1.5;" width="1277.5" x="20" y="1363.9688"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="19" x="35" y="1377.0356">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="90" x="99" y="1376.1792">[Poll Pending]</text><polygon fill="#181818" points="282,1416.3672,272,1420.3672,282,1424.3672,278,1420.3672" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="276" x2="1231" y1="1420.3672" y2="1420.3672"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="30" x="288" y="1415.3013">[19]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="174" x="322" y="1415.3013">400 Bad Request (Pending)</text><path d="M30,1386.1016 L30,1441.1016 L256,1441.1016 L256,1396.1016 L246,1386.1016 L30,1386.1016 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><path d="M246,1386.1016 L246,1396.1016 L256,1396.1016 L246,1386.1016 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="8" x="36" y="1403.1685">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="197" x="44" y="1418.3013">"error":"authorization_pending"</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="8" x="36" y="1433.4341">}</text><line style="stroke:#000000;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="20" x2="1297.5" y1="1447.5" y2="1447.5"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="90" x="25" y="1457.7104">[Poll Success]</text><polygon fill="#181818" points="282,1496.5703,272,1500.5703,282,1504.5703,278,1500.5703" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="276" x2="1231" y1="1500.5703" y2="1500.5703"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="30" x="288" y="1495.5044">[20]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="113" x="322" y="1495.5044">200 OK (Success)</text><path d="M100,1466.3047 L100,1521.3047 L256,1521.3047 L256,1476.3047 L246,1466.3047 L100,1466.3047 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><path d="M246,1466.3047 L246,1476.3047 L256,1476.3047 L246,1466.3047 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="8" x="106" y="1483.3716">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="127" x="114" y="1498.5044">"access_token": "..."</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="8" x="106" y="1513.6372">}</text><line style="stroke:#000000;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="20" x2="1297.5" y1="1527.7031" y2="1527.7031"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="69" x="25" y="1537.9136">[Poll Error]</text><polygon fill="#181818" points="282,1607.0391,272,1611.0391,282,1615.0391,278,1611.0391" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="276" x2="1231" y1="1611.0391" y2="1611.0391"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="30" x="288" y="1605.9731">[21]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="154" x="322" y="1605.9731">400 Bad Request (Error)</text><path d="M74,1546.5078 L74,1661.5078 L256,1661.5078 L256,1556.5078 L246,1546.5078 L74,1546.5078 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><path d="M246,1546.5078 L246,1556.5078 L256,1556.5078 L246,1546.5078 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="8" x="80" y="1563.5747">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="153" x="88" y="1578.7075">"error": "access_denied"</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="29" x="88" y="1593.8403">..or..</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="149" x="88" y="1608.9731">"error": "expired_token"</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="29" x="88" y="1624.106">..or..</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="126" x="88" y="1639.2388">"error": "slow_down"</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="8" x="80" y="1654.3716">}</text><rect fill="#EEEEEE" height="3" style="stroke:#EEEEEE;stroke-width:1.0;" width="1843" x="0" y="1702.0039"/><line style="stroke:#000000;stroke-width:1.0;" x1="0" x2="1843" y1="1702.0039" y2="1702.0039"/><line style="stroke:#000000;stroke-width:1.0;" x1="0" x2="1843" y1="1705.0039" y2="1705.0039"/><rect fill="#EEEEEE" height="23.1328" style="stroke:#000000;stroke-width:2.0;" width="157" x="843" y="1691.4375"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="138" x="849" y="1707.5044">...fachlicher flow...</text><!--MD5=[bb6c3df5dffffa73f3e31a91eb3556ce]
@startuml
autonumber 1 1 "<b>[00]"
title "Entkoppelte FHIR-VZD Authentisierung"

actor User as "Leistungserbringer"
participant TIMClient as "TI-M Client"
participant Authenticator as "gematik Authenticator"

participant "gematik IDP-Dienst" as IdpDienst
box VZD-FHIR-Directory #WhiteSmoke
    participant "Auth-Service" as VzdAuth
end box

User->TIMClient++: Anmeldung starten

TIMClient -> VzdAuth++: Decoupled Authorization Request\nPOST /owner-authenticate-decoupled\nHeader: Content-Type=application/x-www-form-urlencoded\nBody: grant_type=urn:telematik:params:grant-type:decoupled
  VzdAuth -> VzdAuth: Erzeuge PKCE_code_challenge, PKCE_code_verifier und state
VzdAuth -> VzdAuth: Erzeuge auth_req_id
note right: **Siehe Bildungsregel:**\nhttps://openid.net/specs/openid-client-initiated-backchannel\n-authentication-core-1_0.html#rfc.section.7.3
VzdAuth -> VzdAuth: code, state und auth_req_id werden als Autorisierungsauftrag\n in einem persistent Store gespeichert


VzdAuth - -> TIMClient: Decoupled Authorization Response 200 OK \n(\n\t"auth_req_id": "...",\n\t"poll_uri": "...",\n\t//{redirect_uri}//: "https://idp-ref.app.ti-dienste.de/auth?\n\t\tresponse_type=code\n\t\t&client_id=GEMgematFHI4HkPrd8SR\n\t\t&scope=fhir-vzd+openid\n\t\t&redirect_uri=https%3A%2F%2Ffhir-directory-ref.vzd.ti-dienste.de%2Fsignin-gematik-idp-dienst\n\t\t&state=HkX8By1qMekEg4a7B1aXyw\n\t\t&code_challenge=a0kY3HugNKgveqhBQjc1tmX4_m-OT7FMF175rDlOIOM\n\t\t&code_challenge_method=S256",\n\t "expires_in": 600,\n\t "interval": 3\n)

par Authenticator Flow

TIMClient -> Authenticator++: Deeplink-Aufruf:\nauthenticator://?\n  challenge_path=//{redirect_uri}//\n\t**&callback=DIRECT**\n\t**&cardType=HBA**
Authenticator <- -> IdpDienst++: Der Authenticator interagiert mit dem IDP\n und über einen Konnektor mit den Smartcards.\nAm Ende des Prozesses erhält der Authenticator\n den auth_code vom IDP. **Siehe nächster Aufruf!**
IdpDienst -> Authenticator: 302 Redirect auf die redirect_uri des VZD-FHIR\n mit dem auth_code und dem state
deactivate IdpDienst
Authenticator -> VzdAuth: Der Authenticator ruft selbst mit einem HTTP Get,\nredirect_uri&code=XXX&state=YYY auf.\n)
VzdAuth -> VzdAuth: Finde via state den Autorisierungsauftrag\nund speichere auth_code in diesem Autorisierungsauftrag
VzdAuth -> Authenticator: 200 OK, Empty Body
Authenticator->Authenticator- -: Anwendung wird beendet
VzdAuth->IdpDienst++: Übergabe des auth_code und des\nkey_verifier an den Token Endpunkt
note left: **Siehe:**\nhttps://github.com/gematik/api-ti-messenger/blob/main/docs/IDP/\nidp.adoc#3231-erzeugung-des-key_verifier-durch-die-relying-party
return signierter id_token
VzdAuth->VzdAuth: Erzeuge owner-accesstoken auf Basis des id_tokens\nund speichere dieses am Autorisierungsauftrag

else TI-M Client pollt

TIMClient -> VzdAuth: Access Token Request POST {poll_uri}\naus Decopled Authorization Response\nBody: auth_req_id={auth_req_id}
VzdAuth->VzdAuth: Prüfe ob für die übergebene auth_req_id\n ein Autorisierungsauftrag vorliegt und \nggf. bereits ein owner-accesstoken

alt Poll Pending
VzdAuth - -> TIMClient: 400 Bad Request (Pending)
note left
{
  "error":"authorization_pending"
}
end note
else Poll Success
VzdAuth -> TIMClient: 200 OK (Success)
note left
{
  "access_token": "..."
}
end note
else Poll Error
VzdAuth -> TIMClient: 400 Bad Request (Error)
note left
{
  "error": "access_denied"
  ..or..
  "error": "expired_token"
  ..or..
  "error": "slow_down"
}
end note
end
deactivate TIMClient
deactivate VzdAuth
end
== ...fachlicher flow... ==
@enduml

PlantUML version 1.2022.13(Sat Nov 19 13:22:17 UTC 2022)
(GPL source distribution)
Java Runtime: OpenJDK Runtime Environment
JVM: OpenJDK 64-Bit Server VM
Default Encoding: UTF-8
Language: en
Country: null
--></g></svg>