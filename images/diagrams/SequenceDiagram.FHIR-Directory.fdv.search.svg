<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentStyleType="text/css" height="1319px" preserveAspectRatio="none" style="width:1546px;height:1319px;background:#FFFFFF;" version="1.1" viewBox="0 0 1546 1319" width="1546px" zoomAndPan="magnify"><defs/><g><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacing" textLength="331" x="603.75" y="27.9951">FHIR-VZD Authentisierung für Versicherte</text><rect fill="#F5F5F5" height="1270.4844" style="stroke:#181818;stroke-width:0.5;" width="991" x="378.5" y="43.2969"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="142" x="800.5" y="55.3638">VZD-FHIR-Directory</text><rect fill="#FFFFFF" height="71.2656" style="stroke:#181818;stroke-width:1.0;" width="10" x="430.5" y="279.3281"/><rect fill="#FFFFFF" height="335.3984" style="stroke:#181818;stroke-width:1.0;" width="10" x="666.5" y="401.8594"/><rect fill="#FFFFFF" height="113.3984" style="stroke:#181818;stroke-width:1.0;" width="10" x="666.5" y="1131.7891"/><rect fill="#FFFFFF" height="212.7344" style="stroke:#181818;stroke-width:1.0;" width="10" x="1058.5" y="824.6563"/><rect fill="#FFFFFF" height="44.2656" style="stroke:#181818;stroke-width:1.0;" width="10" x="1304.5" y="920.0547"/><rect fill="#FFFFFF" height="29.1328" style="stroke:#181818;stroke-width:1.0;" width="10" x="1442.5" y="206.2578"/><rect fill="#FFFFFF" height="44.2656" style="stroke:#181818;stroke-width:1.0;" width="10" x="1442.5" y="527.5234"/><rect fill="none" height="190.6016" style="stroke:#000000;stroke-width:1.5;" width="1519.5" x="10" y="167.9922"/><rect fill="none" height="219.8672" style="stroke:#000000;stroke-width:1.5;" width="918.5" x="611" y="416.8594"/><rect fill="none" height="163.6016" style="stroke:#000000;stroke-width:1.5;" width="1365.5" x="10" y="881.7891"/><line style="stroke:#181818;stroke-width:0.5;stroke-dasharray:5.0,5.0;" x1="90" x2="90" y1="93.7266" y2="1263.1875"/><line style="stroke:#181818;stroke-width:0.5;stroke-dasharray:5.0,5.0;" x1="435.5" x2="435.5" y1="93.7266" y2="1263.1875"/><line style="stroke:#181818;stroke-width:0.5;stroke-dasharray:5.0,5.0;" x1="671" x2="671" y1="93.7266" y2="1263.1875"/><line style="stroke:#181818;stroke-width:0.5;stroke-dasharray:5.0,5.0;" x1="1063" x2="1063" y1="93.7266" y2="1263.1875"/><line style="stroke:#181818;stroke-width:0.5;stroke-dasharray:5.0,5.0;" x1="1309.5" x2="1309.5" y1="93.7266" y2="1263.1875"/><line style="stroke:#181818;stroke-width:0.5;stroke-dasharray:5.0,5.0;" x1="1447.5" x2="1447.5" y1="93.7266" y2="1263.1875"/><rect fill="#E2E2F0" height="30.2969" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="141" x="20" y="62.4297"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="127" x="27" y="82.4248">Client Versicherter</text><rect fill="#E2E2F0" height="30.2969" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="141" x="20" y="1262.1875"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="127" x="27" y="1282.1826">Client Versicherter</text><rect fill="#E2E2F0" height="30.2969" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="106" x="382.5" y="62.4297"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="92" x="389.5" y="82.4248">OAuth-Server</text><rect fill="#E2E2F0" height="30.2969" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="106" x="382.5" y="1262.1875"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="92" x="389.5" y="1282.1826">OAuth-Server</text><rect fill="#E2E2F0" height="30.2969" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="101" x="621" y="62.4297"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="87" x="628" y="82.4248">Auth-Service</text><rect fill="#E2E2F0" height="30.2969" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="101" x="621" y="1262.1875"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="87" x="628" y="1282.1826">Auth-Service</text><rect fill="#E2E2F0" height="30.2969" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="87" x="1020" y="62.4297"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="73" x="1027" y="82.4248">FHIR-Proxy</text><rect fill="#E2E2F0" height="30.2969" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="87" x="1020" y="1262.1875"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="73" x="1027" y="1282.1826">FHIR-Proxy</text><rect fill="#E2E2F0" height="30.2969" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="112" x="1253.5" y="62.4297"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="98" x="1260.5" y="82.4248">FHIR-Directory</text><rect fill="#E2E2F0" height="30.2969" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="112" x="1253.5" y="1262.1875"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="98" x="1260.5" y="1282.1826">FHIR-Directory</text><rect fill="#E2E2F0" height="46.5938" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="144" x="1375.5" y="46.1328"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="129" x="1383" y="66.1279">Matrix-Homeserver</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="130" x="1382.5" y="82.4248">(Messenger-Proxy)</text><rect fill="#E2E2F0" height="46.5938" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="144" x="1375.5" y="1262.1875"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="129" x="1383" y="1282.1826">Matrix-Homeserver</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="130" x="1382.5" y="1298.4795">(Messenger-Proxy)</text><rect fill="#FFFFFF" height="71.2656" style="stroke:#181818;stroke-width:1.0;" width="10" x="430.5" y="279.3281"/><rect fill="#FFFFFF" height="335.3984" style="stroke:#181818;stroke-width:1.0;" width="10" x="666.5" y="401.8594"/><rect fill="#FFFFFF" height="113.3984" style="stroke:#181818;stroke-width:1.0;" width="10" x="666.5" y="1131.7891"/><rect fill="#FFFFFF" height="212.7344" style="stroke:#181818;stroke-width:1.0;" width="10" x="1058.5" y="824.6563"/><rect fill="#FFFFFF" height="44.2656" style="stroke:#181818;stroke-width:1.0;" width="10" x="1304.5" y="920.0547"/><rect fill="#FFFFFF" height="29.1328" style="stroke:#181818;stroke-width:1.0;" width="10" x="1442.5" y="206.2578"/><rect fill="#FFFFFF" height="44.2656" style="stroke:#181818;stroke-width:1.0;" width="10" x="1442.5" y="527.5234"/><line style="stroke:#181818;stroke-width:1.0;" x1="90.5" x2="132.5" y1="139.9922" y2="139.9922"/><line style="stroke:#181818;stroke-width:1.0;" x1="132.5" x2="132.5" y1="139.9922" y2="152.9922"/><line style="stroke:#181818;stroke-width:1.0;" x1="91.5" x2="132.5" y1="152.9922" y2="152.9922"/><polygon fill="#181818" points="101.5,148.9922,91.5,152.9922,101.5,156.9922,97.5,152.9922" style="stroke:#181818;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="30" x="97.5" y="127.3599">[01]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="297" x="131.5" y="119.7935">prüfe ob noch gültiges search-ACCESS_TOKEN</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="260" x="131.5" y="134.9263">vom FHIR-Directory Auth-Service vorliegt</text><path d="M10,167.9922 L74,167.9922 L74,175.125 L64,185.125 L10,185.125 L10,167.9922 " fill="#EEEEEE" style="stroke:#000000;stroke-width:1.5;"/><rect fill="none" height="190.6016" style="stroke:#000000;stroke-width:1.5;" width="1519.5" x="10" y="167.9922"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="19" x="25" y="181.0591">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="395" x="89" y="180.2026">[kein gültiges search-ACCESS_TOKEN vorhanden - TIM Client]</text><polygon fill="#181818" points="1430.5,202.2578,1440.5,206.2578,1430.5,210.2578,1434.5,206.2578" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="90.5" x2="1436.5" y1="206.2578" y2="206.2578"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="30" x="97.5" y="201.1919">[02]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="379" x="131.5" y="201.1919">POST /_matrix/client/r0/user/{userId}/openid/request_token</text><polygon fill="#181818" points="101.5,231.3906,91.5,235.3906,101.5,239.3906,97.5,235.3906" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="95.5" x2="1446.5" y1="235.3906" y2="235.3906"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="30" x="107.5" y="230.3247">[03]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="720" x="141.5" y="230.3247">HTTP 200 OK, Result body {"access_token": "Matrix-OpenID-Token",..., "matrix_server_name": "example.com",...}</text><line style="stroke:#000000;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="10" x2="1529.5" y1="244.3906" y2="244.3906"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="460" x="15" y="254.6011">[kein gültiges search-ACCESS_TOKEN vorhanden - alle anderen Clients]</text><polygon fill="#181818" points="418.5,275.3281,428.5,279.3281,418.5,283.3281,422.5,279.3281" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="90.5" x2="424.5" y1="279.3281" y2="279.3281"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="30" x="97.5" y="274.2622">[04]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="233" x="131.5" y="274.2622">POST /token (client_id, client_secret)</text><line style="stroke:#181818;stroke-width:1.0;" x1="440.5" x2="482.5" y1="308.4609" y2="308.4609"/><line style="stroke:#181818;stroke-width:1.0;" x1="482.5" x2="482.5" y1="308.4609" y2="321.4609"/><line style="stroke:#181818;stroke-width:1.0;" x1="441.5" x2="482.5" y1="321.4609" y2="321.4609"/><polygon fill="#181818" points="451.5,317.4609,441.5,321.4609,451.5,325.4609,447.5,321.4609" style="stroke:#181818;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="30" x="447.5" y="303.395">[05]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="178" x="481.5" y="303.395">prüfe client_id, client_secret</text><polygon fill="#181818" points="101.5,346.5938,91.5,350.5938,101.5,354.5938,97.5,350.5938" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="95.5" x2="434.5" y1="350.5938" y2="350.5938"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="30" x="107.5" y="345.5278">[06]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="130" x="141.5" y="345.5278">patient-accesstoken</text><polygon fill="#181818" points="654.5,397.8594,664.5,401.8594,654.5,405.8594,658.5,401.8594" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="90.5" x2="660.5" y1="401.8594" y2="401.8594"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="30" x="97.5" y="389.2271">[07]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="164" x="131.5" y="381.6606">GET /patient-authenticate</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="468" x="131.5" y="396.7935">(Authorization: "Bearer patient-accesstoken ODER Matrix-OpenID-Token")</text><path d="M611,416.8594 L675,416.8594 L675,423.9922 L665,433.9922 L611,433.9922 L611,416.8594 " fill="#EEEEEE" style="stroke:#000000;stroke-width:1.5;"/><rect fill="none" height="219.8672" style="stroke:#000000;stroke-width:1.5;" width="918.5" x="611" y="416.8594"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="19" x="626" y="429.9263">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="580" x="690" y="429.0698">[kein gültiges search-ACCESS_TOKEN vorhanden - Authorization mit Matrix-OpenID-Token]</text><line style="stroke:#181818;stroke-width:1.0;" x1="676.5" x2="718.5" y1="470.2578" y2="470.2578"/><line style="stroke:#181818;stroke-width:1.0;" x1="718.5" x2="718.5" y1="470.2578" y2="483.2578"/><line style="stroke:#181818;stroke-width:1.0;" x1="677.5" x2="718.5" y1="483.2578" y2="483.2578"/><polygon fill="#181818" points="687.5,479.2578,677.5,483.2578,687.5,487.2578,683.5,483.2578" style="stroke:#181818;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="30" x="683.5" y="457.6255">[08]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="189" x="717.5" y="450.0591">Prüfe ob matrix_server_name</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="181" x="717.5" y="465.1919">in Föderationsliste enthalten</text><polygon fill="#181818" points="1430.5,523.5234,1440.5,527.5234,1430.5,531.5234,1434.5,527.5234" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="676.5" x2="1436.5" y1="527.5234" y2="527.5234"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="30" x="683.5" y="514.8911">[09]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="135" x="717.5" y="507.3247">GET /openid/userinfo/</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="380" x="717.5" y="522.4575">request header, Authorization: Bearer Matrix-OpenID-Token</text><polygon fill="#181818" points="687.5,567.7891,677.5,571.7891,687.5,575.7891,683.5,571.7891" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="681.5" x2="1446.5" y1="571.7891" y2="571.7891"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="30" x="693.5" y="559.1567">[10]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="82" x="727.5" y="551.5903">HTTP 200 OK</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="202" x="727.5" y="566.7231">(Result Body MXID des Nutzers)</text><line style="stroke:#000000;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="611" x2="1529.5" y1="580.7891" y2="580.7891"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="575" x="616" y="590.9995">[kein gültiges search-ACCESS_TOKEN vorhanden - Authorization mit patient-accesstoken]</text><line style="stroke:#181818;stroke-width:1.0;" x1="676.5" x2="718.5" y1="615.7266" y2="615.7266"/><line style="stroke:#181818;stroke-width:1.0;" x1="718.5" x2="718.5" y1="615.7266" y2="628.7266"/><line style="stroke:#181818;stroke-width:1.0;" x1="677.5" x2="718.5" y1="628.7266" y2="628.7266"/><polygon fill="#181818" points="687.5,624.7266,677.5,628.7266,687.5,632.7266,683.5,628.7266" style="stroke:#181818;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="30" x="683.5" y="610.6606">[11]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="167" x="717.5" y="610.6606">Prüfe patient-accesstoken</text><line style="stroke:#181818;stroke-width:1.0;" x1="676.5" x2="718.5" y1="664.8594" y2="664.8594"/><line style="stroke:#181818;stroke-width:1.0;" x1="718.5" x2="718.5" y1="664.8594" y2="677.8594"/><line style="stroke:#181818;stroke-width:1.0;" x1="677.5" x2="718.5" y1="677.8594" y2="677.8594"/><polygon fill="#181818" points="687.5,673.8594,677.5,677.8594,687.5,681.8594,683.5,677.8594" style="stroke:#181818;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="30" x="683.5" y="659.7935">[12]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="334" x="717.5" y="659.7935">Erzeuge search-ACCESS_TOKEN &amp; REFRESH_TOKEN</text><polygon fill="#181818" points="101.5,733.2578,91.5,737.2578,101.5,741.2578,97.5,737.2578" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="95.5" x2="670.5" y1="737.2578" y2="737.2578"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="30" x="107.5" y="717.0591">[13]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="471" x="141.5" y="701.9263">HTTP 200 OK, Result body mit search-ACCESS_TOKEN &amp; REFRESH_TOKEN</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="426" x="141.5" y="717.0591">{"access_token"="search-ACCESS_TOKEN", "token_type":"bearer",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="126" x="141.5" y="732.1919">"expires_in":86400}</text><rect fill="#EEEEEE" height="3" style="stroke:#EEEEEE;stroke-width:1.0;" width="1539.5" x="0" y="765.8242"/><line style="stroke:#000000;stroke-width:1.0;" x1="0" x2="1539.5" y1="765.8242" y2="765.8242"/><line style="stroke:#000000;stroke-width:1.0;" x1="0" x2="1539.5" y1="768.8242" y2="768.8242"/><rect fill="#EEEEEE" height="23.1328" style="stroke:#000000;stroke-width:2.0;" width="327" x="606.25" y="755.2578"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="308" x="612.25" y="771.3247">...Suche durch Versicherte im FHIR VZD...</text><polygon fill="#181818" points="1046.5,820.6563,1056.5,824.6563,1046.5,828.6563,1050.5,824.6563" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="90.5" x2="1052.5" y1="824.6563" y2="824.6563"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="30" x="97.5" y="812.0239">[14]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="210" x="131.5" y="804.4575">GET /search?... (Auth Header mit</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="156" x="131.5" y="819.5903">search-ACCESS_TOKEN)</text><line style="stroke:#181818;stroke-width:1.0;" x1="1068.5" x2="1110.5" y1="853.7891" y2="853.7891"/><line style="stroke:#181818;stroke-width:1.0;" x1="1110.5" x2="1110.5" y1="853.7891" y2="866.7891"/><line style="stroke:#181818;stroke-width:1.0;" x1="1069.5" x2="1110.5" y1="866.7891" y2="866.7891"/><polygon fill="#181818" points="1079.5,862.7891,1069.5,866.7891,1079.5,870.7891,1075.5,866.7891" style="stroke:#181818;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="30" x="1075.5" y="848.7231">[15]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="188" x="1109.5" y="848.7231">prüfe search-ACCESS_TOKEN</text><path d="M10,881.7891 L74,881.7891 L74,888.9219 L64,898.9219 L10,898.9219 L10,881.7891 " fill="#EEEEEE" style="stroke:#000000;stroke-width:1.5;"/><rect fill="none" height="163.6016" style="stroke:#000000;stroke-width:1.5;" width="1365.5" x="10" y="881.7891"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="19" x="25" y="894.856">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="208" x="89" y="893.9995">[search-ACCESS_TOKEN is valid]</text><polygon fill="#181818" points="1292.5,916.0547,1302.5,920.0547,1292.5,924.0547,1296.5,920.0547" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="1068.5" x2="1298.5" y1="920.0547" y2="920.0547"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="30" x="1075.5" y="914.9888">[16]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="52" x="1109.5" y="914.9888">GET /?...</text><polygon fill="#181818" points="1079.5,960.3203,1069.5,964.3203,1079.5,968.3203,1075.5,964.3203" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="1073.5" x2="1308.5" y1="964.3203" y2="964.3203"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="30" x="1085.5" y="951.688">[17]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="82" x="1119.5" y="944.1216">HTTP 200 OK</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="115" x="1119.5" y="959.2544">(Result Body json)</text><polygon fill="#181818" points="101.5,989.4531,91.5,993.4531,101.5,997.4531,97.5,993.4531" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="95.5" x2="1057.5" y1="993.4531" y2="993.4531"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="30" x="107.5" y="988.3872">[18]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="201" x="141.5" y="988.3872">HTTP 200 OK (Result Body json)</text><line style="stroke:#000000;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="10" x2="1375.5" y1="1002.4531" y2="1002.4531"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="200" x="15" y="1012.6636">[search-accesstoken is invalid]</text><polygon fill="#181818" points="101.5,1033.3906,91.5,1037.3906,101.5,1041.3906,97.5,1037.3906" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="95.5" x2="1062.5" y1="1037.3906" y2="1037.3906"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="30" x="107.5" y="1032.3247">[19]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="60" x="141.5" y="1032.3247">HTTP 401</text><rect fill="#EEEEEE" height="3" style="stroke:#EEEEEE;stroke-width:1.0;" width="1539.5" x="0" y="1072.957"/><line style="stroke:#000000;stroke-width:1.0;" x1="0" x2="1539.5" y1="1072.957" y2="1072.957"/><line style="stroke:#000000;stroke-width:1.0;" x1="0" x2="1539.5" y1="1075.957" y2="1075.957"/><rect fill="#EEEEEE" height="23.1328" style="stroke:#000000;stroke-width:2.0;" width="305" x="617.25" y="1062.3906"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="286" x="623.25" y="1078.4575">...search-ACCESS_TOKEN abgelaufen...</text><polygon fill="#181818" points="654.5,1127.7891,664.5,1131.7891,654.5,1135.7891,658.5,1131.7891" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="90.5" x2="660.5" y1="1131.7891" y2="1131.7891"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="30" x="97.5" y="1119.1567">[20]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="164" x="131.5" y="1111.5903">GET /patient-authenticate</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="268" x="131.5" y="1126.7231">(Authorization: "Bearer REFRESH_TOKEN")</text><line style="stroke:#181818;stroke-width:1.0;" x1="676.5" x2="718.5" y1="1160.9219" y2="1160.9219"/><line style="stroke:#181818;stroke-width:1.0;" x1="718.5" x2="718.5" y1="1160.9219" y2="1173.9219"/><line style="stroke:#181818;stroke-width:1.0;" x1="677.5" x2="718.5" y1="1173.9219" y2="1173.9219"/><polygon fill="#181818" points="687.5,1169.9219,677.5,1173.9219,687.5,1177.9219,683.5,1173.9219" style="stroke:#181818;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="30" x="683.5" y="1155.856">[21]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="145" x="717.5" y="1155.856">Prüfe REFRESH_TOKEN</text><line style="stroke:#181818;stroke-width:1.0;" x1="676.5" x2="718.5" y1="1203.0547" y2="1203.0547"/><line style="stroke:#181818;stroke-width:1.0;" x1="718.5" x2="718.5" y1="1203.0547" y2="1216.0547"/><line style="stroke:#181818;stroke-width:1.0;" x1="677.5" x2="718.5" y1="1216.0547" y2="1216.0547"/><polygon fill="#181818" points="687.5,1212.0547,677.5,1216.0547,687.5,1220.0547,683.5,1216.0547" style="stroke:#181818;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="30" x="683.5" y="1197.9888">[22]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="334" x="717.5" y="1197.9888">Erzeuge search-ACCESS_TOKEN &amp; REFRESH_TOKEN</text><polygon fill="#181818" points="101.5,1241.1875,91.5,1245.1875,101.5,1249.1875,97.5,1245.1875" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="95.5" x2="670.5" y1="1245.1875" y2="1245.1875"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="30" x="107.5" y="1240.1216">[23]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="354" x="141.5" y="1240.1216">Response (search-ACCESS_TOKEN &amp; REFRESH_TOKEN)</text><!--MD5=[600b6017f53bc3147aad0a996722715e]
@startuml
autonumber 1 1 "<b>[00]"
title "FHIR-VZD Authentisierung für Versicherte"

participant VClient as "Client Versicherter"

box VZD-FHIR-Directory #WhiteSmoke
    participant "OAuth-Server" as VzdOAuth
    participant "Auth-Service" as VzdAuth
    participant fp as "FHIR-Proxy"
    participant fd as "FHIR-Directory"
end box

participant hs as "Matrix-Homeserver\n(Messenger-Proxy)"

VClient-> VClient: prüfe ob noch gültiges search-ACCESS_TOKEN\nvom FHIR-Directory Auth-Service vorliegt

alt kein gültiges search-ACCESS_TOKEN vorhanden - TIM Client
VClient-> hs: POST /_matrix/client/r0/user/{userId}/openid/request_token
activate hs
hs - -> VClient: HTTP 200 OK, Result body {"access_token": "Matrix-OpenID-Token",..., "matrix_server_name": "example.com",...}
deactivate hs
 else kein gültiges search-ACCESS_TOKEN vorhanden - alle anderen Clients
VClient->VzdOAuth++: POST /token (client_id, client_secret)
VzdOAuth->VzdOAuth: prüfe client_id, client_secret
VzdOAuth- ->VClient: patient-accesstoken
deactivate VzdOAuth
end

VClient->VzdAuth++: GET /patient-authenticate \n(Authorization: "Bearer patient-accesstoken ODER Matrix-OpenID-Token")

alt kein gültiges search-ACCESS_TOKEN vorhanden - Authorization mit Matrix-OpenID-Token

VzdAuth-> VzdAuth: Prüfe ob matrix_server_name\nin Föderationsliste enthalten
VzdAuth-> hs: GET /openid/userinfo/\nrequest header, Authorization: Bearer Matrix-OpenID-Token
activate hs
hs - -> VzdAuth: HTTP 200 OK\n(Result Body MXID des Nutzers)
deactivate hs

 else kein gültiges search-ACCESS_TOKEN vorhanden - Authorization mit patient-accesstoken

VzdAuth->VzdAuth: Prüfe patient-accesstoken
end

VzdAuth->VzdAuth: Erzeuge search-ACCESS_TOKEN & REFRESH_TOKEN
VzdAuth- -> VClient: HTTP 200 OK, Result body mit search-ACCESS_TOKEN & REFRESH_TOKEN\n{"access_token"="search-ACCESS_TOKEN", "token_type":"bearer",\n"expires_in":86400}
deactivate VzdAuth

== ...Suche durch Versicherte im FHIR VZD... ==

VClient -> fp: GET /search?... (Auth Header mit\nsearch-ACCESS_TOKEN)
activate fp
fp -> fp: prüfe search-ACCESS_TOKEN

alt search-ACCESS_TOKEN is valid
fp -> fd: GET /?...
activate fd
fd - -> fp: HTTP 200 OK\n(Result Body json)
deactivate fd
fp - -> VClient : HTTP 200 OK (Result Body json)
else search-accesstoken is invalid
fp - -> VClient : HTTP 401
deactivate fp
end

== ...search-ACCESS_TOKEN abgelaufen... ==

VClient->VzdAuth++: GET /patient-authenticate \n(Authorization: "Bearer REFRESH_TOKEN")
VzdAuth->VzdAuth: Prüfe REFRESH_TOKEN
VzdAuth->VzdAuth: Erzeuge search-ACCESS_TOKEN & REFRESH_TOKEN

VzdAuth- ->VClient: Response (search-ACCESS_TOKEN & REFRESH_TOKEN)
deactivate VzdAuth
deactivate VzdAuth

@enduml

PlantUML version 1.2022.13(Sat Nov 19 13:22:17 UTC 2022)
(GPL source distribution)
Java Runtime: OpenJDK Runtime Environment
JVM: OpenJDK 64-Bit Server VM
Default Encoding: UTF-8
Language: en
Country: null
--></g></svg>