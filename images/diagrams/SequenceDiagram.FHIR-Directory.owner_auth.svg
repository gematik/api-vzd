<svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentStyleType="text/css" data-diagram-type="SEQUENCE" height="708.3333px" preserveAspectRatio="none" style="width:1064px;height:708px;background:#FFFFFF;" version="1.1" viewBox="0 0 1064 708" width="1064.5833px" zoomAndPan="magnify"><defs/><g><rect fill="#F5F5F5" height="695.9147" style="stroke:#181818;stroke-width:0.5208;" width="195.4371" x="863.1037" y="6.25"/><text fill="#000000" font-family="sans-serif" font-size="16.6667" font-weight="bold" lengthAdjust="spacing" textLength="184.4727" x="866.2287" y="21.7204">VZD-FHIR-Directory</text><text fill="#000000" font-family="sans-serif" font-size="13.5417" font-weight="bold" lengthAdjust="spacing" textLength="4.7145" x="1050.7014" y="22.4574">&#160;</text><g><title>TI-Messenger-Client</title><rect fill="#FFFFFF" height="584.2285" style="stroke:#181818;stroke-width:1.0417;" width="10.4167" x="79.863" y="72.8353"/></g><g><title>Smartcard(HBA/SMC-B)</title><rect fill="#FFFFFF" height="30.3467" style="stroke:#181818;stroke-width:1.0417;" width="10.4167" x="604.9164" y="356.0954"/></g><g><title>gematik IDP</title><rect fill="#FFFFFF" height="30.3467" style="stroke:#181818;stroke-width:1.0417;" width="10.4167" x="800.0804" y="181.5837"/></g><g><title>gematik IDP</title><rect fill="#FFFFFF" height="30.3467" style="stroke:#181818;stroke-width:1.0417;" width="10.4167" x="800.0804" y="530.6071"/></g><g><title>Auth-Service</title><rect fill="#FFFFFF" height="30.3467" style="stroke:#181818;stroke-width:1.0417;" width="10.4167" x="955.614" y="94.8486"/></g><g><title>Auth-Service</title><rect fill="#FFFFFF" height="30.3467" style="stroke:#181818;stroke-width:1.0417;" width="10.4167" x="955.614" y="617.3421"/></g><g><title>TI-Messenger-Client</title><rect fill="#000000" fill-opacity="0.00000" height="604.0202" width="8.3333" x="80.9046" y="62.4186"/><line style="stroke:#181818;stroke-width:0.5208;stroke-dasharray:5.0,5.0;" x1="84.375" x2="84.375" y1="62.4186" y2="666.4388"/></g><g><title>Smartcard(HBA/SMC-B)</title><rect fill="#000000" fill-opacity="0.00000" height="604.0202" width="8.3333" x="605.958" y="62.4186"/><line style="stroke:#181818;stroke-width:0.5208;stroke-dasharray:5.0,5.0;" x1="610.1171" x2="610.1171" y1="62.4186" y2="666.4388"/></g><g><title>gematik IDP</title><rect fill="#000000" fill-opacity="0.00000" height="604.0202" width="8.3333" x="801.122" y="62.4186"/><line style="stroke:#181818;stroke-width:0.5208;stroke-dasharray:5.0,5.0;" x1="804.7653" x2="804.7653" y1="62.4186" y2="666.4388"/></g><g><title>Auth-Service</title><rect fill="#000000" fill-opacity="0.00000" height="604.0202" width="8.3333" x="956.6556" y="62.4186"/><line style="stroke:#181818;stroke-width:0.5208;stroke-dasharray:5.0,5.0;" x1="959.9861" x2="959.9861" y1="62.4186" y2="666.4388"/></g><g class="participant participant-head" data-participant="mc"><rect fill="#E3E3E3" height="31.5592" rx="2.6042" ry="2.6042" style="stroke:#181818;stroke-width:0.5208;" width="159.726" x="5.2083" y="29.8177"/><text fill="#000000" font-family="sans-serif" font-size="14.5833" lengthAdjust="spacing" textLength="145.1426" x="12.5" y="50.646">TI-Messenger-Client</text></g><g class="participant participant-tail" data-participant="mc"><rect fill="#E3E3E3" height="31.5592" rx="2.6042" ry="2.6042" style="stroke:#181818;stroke-width:0.5208;" width="159.726" x="5.2083" y="665.3971"/><text fill="#000000" font-family="sans-serif" font-size="14.5833" lengthAdjust="spacing" textLength="145.1426" x="12.5" y="686.2254">TI-Messenger-Client</text></g><g class="participant participant-head" data-participant="sc"><rect fill="#E3E3E3" height="31.5592" rx="2.6042" ry="2.6042" style="stroke:#181818;stroke-width:0.5208;" width="185.4319" x="517.4088" y="29.8177"/><text fill="#000000" font-family="sans-serif" font-size="14.5833" lengthAdjust="spacing" textLength="170.8486" x="524.7004" y="50.646">Smartcard(HBA/SMC-B)</text></g><g class="participant participant-tail" data-participant="sc"><rect fill="#E3E3E3" height="31.5592" rx="2.6042" ry="2.6042" style="stroke:#181818;stroke-width:0.5208;" width="185.4319" x="517.4088" y="665.3971"/><text fill="#000000" font-family="sans-serif" font-size="14.5833" lengthAdjust="spacing" textLength="170.8486" x="524.7004" y="686.2254">Smartcard(HBA/SMC-B)</text></g><g class="participant participant-head" data-participant="idp"><rect fill="#E3E3E3" height="31.5592" rx="2.6042" ry="2.6042" style="stroke:#181818;stroke-width:0.5208;" width="103.1301" x="753.7237" y="29.8177"/><text fill="#000000" font-family="sans-serif" font-size="14.5833" lengthAdjust="spacing" textLength="88.5468" x="761.0153" y="50.646">gematik IDP</text></g><g class="participant participant-tail" data-participant="idp"><rect fill="#E3E3E3" height="31.5592" rx="2.6042" ry="2.6042" style="stroke:#181818;stroke-width:0.5208;" width="103.1301" x="753.7237" y="665.3971"/><text fill="#000000" font-family="sans-serif" font-size="14.5833" lengthAdjust="spacing" textLength="88.5468" x="761.0153" y="686.2254">gematik IDP</text></g><g class="participant participant-head" data-participant="auth"><rect fill="#E3E3E3" height="31.5592" rx="2.6042" ry="2.6042" style="stroke:#181818;stroke-width:0.5208;" width="107.9224" x="906.8611" y="29.8177"/><text fill="#000000" font-family="sans-serif" font-size="14.5833" lengthAdjust="spacing" textLength="93.339" x="914.1528" y="50.646">Auth-Service</text></g><g class="participant participant-tail" data-participant="auth"><rect fill="#E3E3E3" height="31.5592" rx="2.6042" ry="2.6042" style="stroke:#181818;stroke-width:0.5208;" width="107.9224" x="906.8611" y="665.3971"/><text fill="#000000" font-family="sans-serif" font-size="14.5833" lengthAdjust="spacing" textLength="93.339" x="914.1528" y="686.2254">Auth-Service</text></g><g><title>TI-Messenger-Client</title><rect fill="#FFFFFF" height="584.2285" style="stroke:#181818;stroke-width:1.0417;" width="10.4167" x="79.863" y="72.8353"/></g><g><title>Smartcard(HBA/SMC-B)</title><rect fill="#FFFFFF" height="30.3467" style="stroke:#181818;stroke-width:1.0417;" width="10.4167" x="604.9164" y="356.0954"/></g><g><title>gematik IDP</title><rect fill="#FFFFFF" height="30.3467" style="stroke:#181818;stroke-width:1.0417;" width="10.4167" x="800.0804" y="181.5837"/></g><g><title>gematik IDP</title><rect fill="#FFFFFF" height="30.3467" style="stroke:#181818;stroke-width:1.0417;" width="10.4167" x="800.0804" y="530.6071"/></g><g><title>Auth-Service</title><rect fill="#FFFFFF" height="30.3467" style="stroke:#181818;stroke-width:1.0417;" width="10.4167" x="955.614" y="94.8486"/></g><g><title>Auth-Service</title><rect fill="#FFFFFF" height="30.3467" style="stroke:#181818;stroke-width:1.0417;" width="10.4167" x="955.614" y="617.3421"/></g><g class="message" data-participant-1="mc" data-participant-2="auth"><polygon fill="#181818" points="943.114,90.682,953.5306,94.8486,943.114,99.0153,947.2806,94.8486" style="stroke:#181818;stroke-width:1.0417;"/><line style="stroke:#181818;stroke-width:1.0417;" x1="90.2796" x2="949.364" y1="94.8486" y2="94.8486"/><text fill="#000000" font-family="sans-serif" font-size="13.5417" font-weight="bold" lengthAdjust="spacing" textLength="31.2225" x="97.5713" y="89.5716">[01]</text><text fill="#000000" font-family="sans-serif" font-size="13.5417" lengthAdjust="spacing" textLength="169.0592" x="132.9605" y="89.5716">GET /owner-authenticate</text></g><g class="message" data-participant-1="auth" data-participant-2="mc"><polygon fill="#181818" points="101.738,121.0286,91.3213,125.1953,101.738,129.362,97.5713,125.1953" style="stroke:#181818;stroke-width:1.0417;"/><line style="stroke:#181818;stroke-width:1.0417;stroke-dasharray:2.0,2.0;" x1="95.488" x2="959.7806" y1="125.1953" y2="125.1953"/><text fill="#000000" font-family="sans-serif" font-size="13.5417" font-weight="bold" lengthAdjust="spacing" textLength="31.2225" x="107.988" y="119.9183">[02]</text><text fill="#000000" font-family="sans-serif" font-size="13.5417" lengthAdjust="spacing" textLength="438.914" x="143.3772" y="119.9183">HTTP 302 redirect to idp auth endpoint with (client_id, scope, ...)</text></g><g class="message" data-participant-1="mc" data-participant-2="idp"><polygon fill="#181818" points="787.5804,177.417,797.997,181.5837,787.5804,185.7503,791.747,181.5837" style="stroke:#181818;stroke-width:1.0417;"/><line style="stroke:#181818;stroke-width:1.0417;" x1="90.2796" x2="793.8304" y1="181.5837" y2="181.5837"/><text fill="#000000" font-family="sans-serif" font-size="13.5417" font-weight="bold" lengthAdjust="spacing" textLength="31.2225" x="97.5713" y="176.3067">[03]</text><text fill="#000000" font-family="sans-serif" font-size="13.5417" lengthAdjust="spacing" textLength="84.5362" x="132.9605" y="176.3067">GET redirect</text></g><g class="message" data-participant-1="idp" data-participant-2="mc"><polygon fill="#181818" points="101.738,207.7637,91.3213,211.9303,101.738,216.097,97.5713,211.9303" style="stroke:#181818;stroke-width:1.0417;"/><line style="stroke:#181818;stroke-width:1.0417;stroke-dasharray:2.0,2.0;" x1="95.488" x2="804.247" y1="211.9303" y2="211.9303"/><text fill="#000000" font-family="sans-serif" font-size="13.5417" font-weight="bold" lengthAdjust="spacing" textLength="31.2225" x="107.988" y="206.6533">[04]</text><text fill="#000000" font-family="sans-serif" font-size="13.5417" lengthAdjust="spacing" textLength="282.3517" x="143.3772" y="206.6533">encoded challenge_token &amp; user_consent</text></g><g class="message" data-participant-1="mc" data-participant-2="mc"><line style="stroke:#181818;stroke-width:1.0417;" x1="90.2796" x2="134.0296" y1="268.3187" y2="268.3187"/><line style="stroke:#181818;stroke-width:1.0417;" x1="134.0296" x2="134.0296" y1="268.3187" y2="281.8604"/><line style="stroke:#181818;stroke-width:1.0417;" x1="91.3213" x2="134.0296" y1="281.8604" y2="281.8604"/><polygon fill="#181818" points="101.738,277.6937,91.3213,281.8604,101.738,286.027,97.5713,281.8604" style="stroke:#181818;stroke-width:1.0417;"/><text fill="#000000" font-family="sans-serif" font-size="13.5417" font-weight="bold" lengthAdjust="spacing" textLength="31.2225" x="97.5713" y="263.0417">[05]</text><text fill="#000000" font-family="sans-serif" font-size="13.5417" lengthAdjust="spacing" textLength="223.1532" x="132.9605" y="263.0417">check challenge_token signature</text></g><g class="message" data-participant-1="mc" data-participant-2="mc"><line style="stroke:#181818;stroke-width:1.0417;" x1="90.2796" x2="134.0296" y1="312.207" y2="312.207"/><line style="stroke:#181818;stroke-width:1.0417;" x1="134.0296" x2="134.0296" y1="312.207" y2="325.7487"/><line style="stroke:#181818;stroke-width:1.0417;" x1="91.3213" x2="134.0296" y1="325.7487" y2="325.7487"/><polygon fill="#181818" points="101.738,321.582,91.3213,325.7487,101.738,329.9154,97.5713,325.7487" style="stroke:#181818;stroke-width:1.0417;"/><text fill="#000000" font-family="sans-serif" font-size="13.5417" font-weight="bold" lengthAdjust="spacing" textLength="31.2225" x="97.5713" y="306.93">[06]</text><text fill="#000000" font-family="sans-serif" font-size="13.5417" lengthAdjust="spacing" textLength="300.9847" x="132.9605" y="306.93">display user_consent and ask for permission</text></g><g class="message" data-participant-1="mc" data-participant-2="sc"><polygon fill="#181818" points="592.4164,351.9287,602.833,356.0954,592.4164,360.262,596.583,356.0954" style="stroke:#181818;stroke-width:1.0417;"/><line style="stroke:#181818;stroke-width:1.0417;" x1="90.2796" x2="598.6664" y1="356.0954" y2="356.0954"/><text fill="#000000" font-family="sans-serif" font-size="13.5417" font-weight="bold" lengthAdjust="spacing" textLength="31.2225" x="97.5713" y="350.8184">[07]</text><text fill="#000000" font-family="sans-serif" font-size="13.5417" lengthAdjust="spacing" textLength="241.4424" x="132.9605" y="350.8184">get private Key for AUTH certificate</text></g><g class="message" data-participant-1="sc" data-participant-2="mc"><polygon fill="#181818" points="101.738,382.2754,91.3213,386.4421,101.738,390.6087,97.5713,386.4421" style="stroke:#181818;stroke-width:1.0417;"/><line style="stroke:#181818;stroke-width:1.0417;stroke-dasharray:2.0,2.0;" x1="95.488" x2="609.083" y1="386.4421" y2="386.4421"/><text fill="#000000" font-family="sans-serif" font-size="13.5417" font-weight="bold" lengthAdjust="spacing" textLength="31.2225" x="107.988" y="381.1651">[08]</text><text fill="#000000" font-family="sans-serif" font-size="13.5417" lengthAdjust="spacing" textLength="76.3702" x="143.3772" y="381.1651">private key</text></g><g class="message" data-participant-1="mc" data-participant-2="mc"><line style="stroke:#181818;stroke-width:1.0417;" x1="90.2796" x2="134.0296" y1="416.7887" y2="416.7887"/><line style="stroke:#181818;stroke-width:1.0417;" x1="134.0296" x2="134.0296" y1="416.7887" y2="430.3304"/><line style="stroke:#181818;stroke-width:1.0417;" x1="91.3213" x2="134.0296" y1="430.3304" y2="430.3304"/><polygon fill="#181818" points="101.738,426.1637,91.3213,430.3304,101.738,434.4971,97.5713,430.3304" style="stroke:#181818;stroke-width:1.0417;"/><text fill="#000000" font-family="sans-serif" font-size="13.5417" font-weight="bold" lengthAdjust="spacing" textLength="31.2225" x="97.5713" y="411.5117">[09]</text><text fill="#000000" font-family="sans-serif" font-size="13.5417" lengthAdjust="spacing" textLength="393.0984" x="132.9605" y="411.5117">sign challenge_token with private key from the smartcard</text></g><g class="message" data-participant-1="mc" data-participant-2="mc"><line style="stroke:#181818;stroke-width:1.0417;" x1="90.2796" x2="134.0296" y1="460.6771" y2="460.6771"/><line style="stroke:#181818;stroke-width:1.0417;" x1="134.0296" x2="134.0296" y1="460.6771" y2="474.2188"/><line style="stroke:#181818;stroke-width:1.0417;" x1="91.3213" x2="134.0296" y1="474.2188" y2="474.2188"/><polygon fill="#181818" points="101.738,470.0521,91.3213,474.2188,101.738,478.3854,97.5713,474.2188" style="stroke:#181818;stroke-width:1.0417;"/><text fill="#000000" font-family="sans-serif" font-size="13.5417" font-weight="bold" lengthAdjust="spacing" textLength="31.2225" x="97.5713" y="455.4001">[10]</text><text fill="#000000" font-family="sans-serif" font-size="13.5417" lengthAdjust="spacing" textLength="454.2475" x="132.9605" y="455.4001">encrypt signed challenge_token with Puk_IDP_ENC provided by IDP</text></g><g class="message" data-participant-1="mc" data-participant-2="idp"><polygon fill="#181818" points="787.5804,526.4404,797.997,530.6071,787.5804,534.7738,791.747,530.6071" style="stroke:#181818;stroke-width:1.0417;"/><line style="stroke:#181818;stroke-width:1.0417;" x1="90.2796" x2="793.8304" y1="530.6071" y2="530.6071"/><text fill="#000000" font-family="sans-serif" font-size="13.5417" font-weight="bold" lengthAdjust="spacing" textLength="31.2225" x="97.5713" y="525.3301">[11]</text><text fill="#000000" font-family="sans-serif" font-size="13.5417" lengthAdjust="spacing" textLength="523.8866" x="132.9605" y="525.3301">POST IDP /[authorization_endpoint] with encrypted &amp; signed challenge_token</text></g><g class="message" data-participant-1="idp" data-participant-2="mc"><polygon fill="#181818" points="101.738,556.7871,91.3213,560.9538,101.738,565.1204,97.5713,560.9538" style="stroke:#181818;stroke-width:1.0417;"/><line style="stroke:#181818;stroke-width:1.0417;stroke-dasharray:2.0,2.0;" x1="95.488" x2="804.247" y1="560.9538" y2="560.9538"/><text fill="#000000" font-family="sans-serif" font-size="13.5417" font-weight="bold" lengthAdjust="spacing" textLength="31.2225" x="107.988" y="555.6768">[12]</text><text fill="#000000" font-family="sans-serif" font-size="13.5417" lengthAdjust="spacing" textLength="649.4115" x="143.3772" y="555.6768">HTTP 302 redirect to VZD-FHIR Directory /signin-gematik-idp-dienst?code=(authorization_code)</text></g><g class="message" data-participant-1="mc" data-participant-2="auth"><polygon fill="#181818" points="943.114,613.1755,953.5306,617.3421,943.114,621.5088,947.2806,617.3421" style="stroke:#181818;stroke-width:1.0417;"/><line style="stroke:#181818;stroke-width:1.0417;" x1="90.2796" x2="949.364" y1="617.3421" y2="617.3421"/><text fill="#000000" font-family="sans-serif" font-size="13.5417" font-weight="bold" lengthAdjust="spacing" textLength="31.2225" x="97.5713" y="612.0651">[13]</text><text fill="#000000" font-family="sans-serif" font-size="13.5417" lengthAdjust="spacing" textLength="536.5753" x="132.9605" y="612.0651">GET VZD-FHIR Directory /signin-gematik-idp-dienst?code=(authorization_code)</text></g><g class="message" data-participant-1="auth" data-participant-2="mc"><polygon fill="#181818" points="101.738,643.5221,91.3213,647.6888,101.738,651.8555,97.5713,647.6888" style="stroke:#181818;stroke-width:1.0417;"/><line style="stroke:#181818;stroke-width:1.0417;stroke-dasharray:2.0,2.0;" x1="95.488" x2="959.7806" y1="647.6888" y2="647.6888"/><text fill="#000000" font-family="sans-serif" font-size="13.5417" font-weight="bold" lengthAdjust="spacing" textLength="31.2225" x="107.988" y="642.4118">[14]</text><text fill="#000000" font-family="sans-serif" font-size="13.5417" lengthAdjust="spacing" textLength="130.7088" x="143.3772" y="642.4118">owneraccess-token</text></g><!--SRC=[hLFHRjf047o_hrXHAI9A32IL-e0e5O6qe2WjAcwH6aNMSLxWP7ndtPr9YVZuxjauifMqJts3zUpipkoSJQJAkE4fn9c4grwFsPVAql1iAMEtXUj6FTLAYwtHAO8pEJAUEwtoT8K6MeFLyA7NUsmnHbWdXSouSf0Au1PQuIouHsjHRT04uvr4vLeDd2rnYvHgWfkuFRqPTHVtu-3cl0cKSLOWDvXo9nEOJUOjjjA_OM3bC_QlFWn__fe4dwUpxy546XHEcyEWwxyDuTroAnqkKfrWWvDaR0lI4Vq85cZsKc2BeOg1c1dZmiazTqXg60aAXcN7nKKVljo6qDLFYcJv6kcImYEPGPSR1TCmdCFxtZKOZ8jrmEbIWsUW2PcMjC6Jf7zjKHWJoVYI_D0PNaAdqpbdn-FnDDOtLbChmceIAg5ZZ45i-MxdZOuSwLHm1hb54mcjo7vN8qj5dy0eabSjLcuK9rAi8MDfinq_DCY0aqFS9h3M1Z8qgRHMQdNgefFwNJVe83EbVtTuAB2Z7-4K1D85reLTbOOAbn2ErORxXLvjMNXMxrXJC85k0BPAKOs2x367p1LKRxXKaCtp9A8yHRTVnqIizzBxkJhuZBrnXFctHUW_GVV17rCR-Ko9r2gghlfOifuc4zNPNwR_ConLdE4bpj3rD585fpSGq4P1JD6nxfFFmCTsSnzVgwUe4Tx_HN-IK3m5BWGzzg3KzWS0]--></g></svg>