<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentStyleType="text/css" height="955.2083px" preserveAspectRatio="none" style="width:1307px;height:955px;background:#FFFFFF;" version="1.1" viewBox="0 0 1307 955" width="1307.2917px" zoomAndPan="magnify"><defs/><g><rect fill="#F5F5F5" height="943.7337" style="stroke:#181818;stroke-width:0.5208333333333334;" width="682.8125" x="451.5625" y="6.25"/><text fill="#000000" font-family="sans-serif" font-size="16.6667" font-weight="bold" lengthAdjust="spacing" textLength="135.4167" x="722.6563" y="21.7204">FHIR-Directory</text><text fill="#000000" font-family="sans-serif" font-size="13.5417" font-weight="bold" lengthAdjust="spacing" textLength="5.2083" x="858.0729" y="22.4574"> </text><rect fill="#FFFFFF" height="761.8652" style="stroke:#181818;stroke-width:1.0416666666666667;" width="10.4167" x="185.4167" y="95.1009"/><rect fill="#FFFFFF" height="221.5983" style="stroke:#181818;stroke-width:1.0416666666666667;" width="10.4167" x="495.8333" y="619.7428"/><rect fill="#FFFFFF" height="257.6335" style="stroke:#181818;stroke-width:1.0416666666666667;" width="10.4167" x="692.7083" y="308.7077"/><rect fill="#FFFFFF" height="46.11" style="stroke:#181818;stroke-width:1.0416666666666667;" width="10.4167" x="1066.6667" y="719.1162"/><rect fill="#FFFFFF" height="30.3467" style="stroke:#181818;stroke-width:1.0416666666666667;" width="10.4167" x="1210.4167" y="248.0143"/><rect fill="#FFFFFF" height="46.11" style="stroke:#181818;stroke-width:1.0416666666666667;" width="10.4167" x="1210.4167" y="414.4694"/><rect height="366.5202" style="stroke:#000000;stroke-width:1.5625;fill:none;" width="1200.5208" x="100.5208" y="208.1543"/><rect height="170.4183" style="stroke:#000000;stroke-width:1.5625;fill:none;" width="1040.1042" x="100.5208" y="679.2562"/><line style="stroke:#181818;stroke-width:0.5208333333333334;fill:none;stroke-dasharray:5.0,5.0;" x1="32.2917" x2="32.2917" y1="84.6842" y2="867.3828"/><line style="stroke:#181818;stroke-width:0.5208333333333334;fill:none;stroke-dasharray:5.0,5.0;" x1="190.1042" x2="190.1042" y1="84.6842" y2="867.3828"/><line style="stroke:#181818;stroke-width:0.5208333333333334;fill:none;stroke-dasharray:5.0,5.0;" x1="500.5208" x2="500.5208" y1="84.6842" y2="867.3828"/><line style="stroke:#181818;stroke-width:0.5208333333333334;fill:none;stroke-dasharray:5.0,5.0;" x1="697.3958" x2="697.3958" y1="84.6842" y2="867.3828"/><line style="stroke:#181818;stroke-width:0.5208333333333334;fill:none;stroke-dasharray:5.0,5.0;" x1="1071.875" x2="1071.875" y1="84.6842" y2="867.3828"/><line style="stroke:#181818;stroke-width:0.5208333333333334;fill:none;stroke-dasharray:5.0,5.0;" x1="1215.625" x2="1215.625" y1="84.6842" y2="867.3828"/><text fill="#000000" font-family="sans-serif" font-size="14.5833" lengthAdjust="spacing" textLength="47.9167" x="5.2083" y="81.2449">Nutzer</text><ellipse cx="32.2917" cy="14.0625" fill="#E3E3E3" rx="8.3333" ry="8.3333" style="stroke:#181818;stroke-width:0.5208333333333334;"/><path d="M32.2917,22.3958 L32.2917,50.5208 M18.75,30.7292 L45.8333,30.7292 M32.2917,50.5208 L18.75,66.1458 M32.2917,50.5208 L45.8333,66.1458 " fill="none" style="stroke:#181818;stroke-width:0.5208333333333334;"/><text fill="#000000" font-family="sans-serif" font-size="14.5833" lengthAdjust="spacing" textLength="47.9167" x="5.2083" y="879.8777">Nutzer</text><ellipse cx="32.2917" cy="892.1712" fill="#E3E3E3" rx="8.3333" ry="8.3333" style="stroke:#181818;stroke-width:0.5208333333333334;"/><path d="M32.2917,900.5046 L32.2917,928.6296 M18.75,908.8379 L45.8333,908.8379 M32.2917,928.6296 L18.75,944.2546 M32.2917,928.6296 L45.8333,944.2546 " fill="none" style="stroke:#181818;stroke-width:0.5208333333333334;"/><rect fill="#E3E3E3" height="31.5592" rx="2.6042" ry="2.6042" style="stroke:#181818;stroke-width:0.5208333333333334;" width="159.375" x="110.9375" y="52.0833"/><text fill="#000000" font-family="sans-serif" font-size="14.5833" lengthAdjust="spacing" textLength="144.7917" x="118.2292" y="72.9116">TI-Messenger-Client</text><rect fill="#E3E3E3" height="31.5592" rx="2.6042" ry="2.6042" style="stroke:#181818;stroke-width:0.5208333333333334;" width="159.375" x="110.9375" y="866.3411"/><text fill="#000000" font-family="sans-serif" font-size="14.5833" lengthAdjust="spacing" textLength="144.7917" x="118.2292" y="887.1694">TI-Messenger-Client</text><rect fill="#E3E3E3" height="31.5592" rx="2.6042" ry="2.6042" style="stroke:#181818;stroke-width:0.5208333333333334;" width="90.625" x="455.7292" y="52.0833"/><text fill="#000000" font-family="sans-serif" font-size="14.5833" lengthAdjust="spacing" textLength="76.0417" x="463.0208" y="72.9116">FHIR-Proxy</text><rect fill="#E3E3E3" height="31.5592" rx="2.6042" ry="2.6042" style="stroke:#181818;stroke-width:0.5208333333333334;" width="90.625" x="455.7292" y="866.3411"/><text fill="#000000" font-family="sans-serif" font-size="14.5833" lengthAdjust="spacing" textLength="76.0417" x="463.0208" y="887.1694">FHIR-Proxy</text><rect fill="#E3E3E3" height="31.5592" rx="2.6042" ry="2.6042" style="stroke:#181818;stroke-width:0.5208333333333334;" width="105.2083" x="645.3125" y="52.0833"/><text fill="#000000" font-family="sans-serif" font-size="14.5833" lengthAdjust="spacing" textLength="90.625" x="652.6042" y="72.9116">Auth-Service</text><rect fill="#E3E3E3" height="31.5592" rx="2.6042" ry="2.6042" style="stroke:#181818;stroke-width:0.5208333333333334;" width="105.2083" x="645.3125" y="866.3411"/><text fill="#000000" font-family="sans-serif" font-size="14.5833" lengthAdjust="spacing" textLength="90.625" x="652.6042" y="887.1694">Auth-Service</text><rect fill="#E3E3E3" height="31.5592" rx="2.6042" ry="2.6042" style="stroke:#181818;stroke-width:0.5208333333333334;" width="116.6667" x="1013.5417" y="52.0833"/><text fill="#000000" font-family="sans-serif" font-size="14.5833" lengthAdjust="spacing" textLength="102.0833" x="1020.8333" y="72.9116">FHIR-Directory</text><rect fill="#E3E3E3" height="31.5592" rx="2.6042" ry="2.6042" style="stroke:#181818;stroke-width:0.5208333333333334;" width="116.6667" x="1013.5417" y="866.3411"/><text fill="#000000" font-family="sans-serif" font-size="14.5833" lengthAdjust="spacing" textLength="102.0833" x="1020.8333" y="887.1694">FHIR-Directory</text><rect fill="#E3E3E3" height="48.5352" rx="2.6042" ry="2.6042" style="stroke:#181818;stroke-width:0.5208333333333334;" width="150" x="1140.625" y="35.1074"/><text fill="#000000" font-family="sans-serif" font-size="14.5833" lengthAdjust="spacing" textLength="134.375" x="1148.4375" y="55.9357">Matrix-Homeserver</text><text fill="#000000" font-family="sans-serif" font-size="14.5833" lengthAdjust="spacing" textLength="135.4167" x="1147.9167" y="72.9116">(Messenger-Proxy)</text><rect fill="#E3E3E3" height="48.5352" rx="2.6042" ry="2.6042" style="stroke:#181818;stroke-width:0.5208333333333334;" width="150" x="1140.625" y="866.3411"/><text fill="#000000" font-family="sans-serif" font-size="14.5833" lengthAdjust="spacing" textLength="134.375" x="1148.4375" y="887.1694">Matrix-Homeserver</text><text fill="#000000" font-family="sans-serif" font-size="14.5833" lengthAdjust="spacing" textLength="135.4167" x="1147.9167" y="904.1453">(Messenger-Proxy)</text><rect fill="#FFFFFF" height="761.8652" style="stroke:#181818;stroke-width:1.0416666666666667;" width="10.4167" x="185.4167" y="95.1009"/><rect fill="#FFFFFF" height="221.5983" style="stroke:#181818;stroke-width:1.0416666666666667;" width="10.4167" x="495.8333" y="619.7428"/><rect fill="#FFFFFF" height="257.6335" style="stroke:#181818;stroke-width:1.0416666666666667;" width="10.4167" x="692.7083" y="308.7077"/><rect fill="#FFFFFF" height="46.11" style="stroke:#181818;stroke-width:1.0416666666666667;" width="10.4167" x="1066.6667" y="719.1162"/><rect fill="#FFFFFF" height="30.3467" style="stroke:#181818;stroke-width:1.0416666666666667;" width="10.4167" x="1210.4167" y="248.0143"/><rect fill="#FFFFFF" height="46.11" style="stroke:#181818;stroke-width:1.0416666666666667;" width="10.4167" x="1210.4167" y="414.4694"/><polygon fill="#181818" points="172.9167,128.7109,183.3333,132.8776,172.9167,137.0443,177.0833,132.8776" style="stroke:#181818;stroke-width:1.0416666666666667;"/><line style="stroke:#181818;stroke-width:1.0416666666666667;" x1="32.2917" x2="179.1667" y1="132.8776" y2="132.8776"/><text fill="#000000" font-family="sans-serif" font-size="13.5417" lengthAdjust="spacing" textLength="63.5417" x="39.5833" y="111.8373">gibt FHIR-</text><text fill="#000000" font-family="sans-serif" font-size="13.5417" lengthAdjust="spacing" textLength="128.125" x="39.5833" y="127.6006">Suchparameter ein</text><line style="stroke:#181818;stroke-width:1.0416666666666667;" x1="195.8333" x2="239.5833" y1="178.9876" y2="178.9876"/><line style="stroke:#181818;stroke-width:1.0416666666666667;" x1="239.5833" x2="239.5833" y1="178.9876" y2="192.5293"/><line style="stroke:#181818;stroke-width:1.0416666666666667;" x1="196.875" x2="239.5833" y1="192.5293" y2="192.5293"/><polygon fill="#181818" points="207.2917,188.3626,196.875,192.5293,207.2917,196.696,203.125,192.5293" style="stroke:#181818;stroke-width:1.0416666666666667;"/><text fill="#000000" font-family="sans-serif" font-size="13.5417" lengthAdjust="spacing" textLength="285.4167" x="203.125" y="157.9473">prüfe ob noch gültiges search-accesstoken</text><text fill="#000000" font-family="sans-serif" font-size="13.5417" lengthAdjust="spacing" textLength="270.8333" x="203.125" y="173.7106">vom FHIR-Directory Auth-Service vorliegt</text><path d="M100.5208,208.1543 L167.1875,208.1543 L167.1875,215.5843 L156.7708,226.001 L100.5208,226.001 L100.5208,208.1543 " fill="#EEEEEE" style="stroke:#000000;stroke-width:1.5625;"/><rect fill="none" height="366.5202" style="stroke:#000000;stroke-width:1.5625;" width="1200.5208" x="100.5208" y="208.1543"/><text fill="#000000" font-family="sans-serif" font-size="13.5417" font-weight="bold" lengthAdjust="spacing" textLength="19.7917" x="116.1458" y="221.7656">alt</text><text fill="#000000" font-family="sans-serif" font-size="11.4583" font-weight="bold" lengthAdjust="spacing" textLength="309.375" x="182.8125" y="220.8735">[kein gültiges search-accesstoken vorhanden]</text><polygon fill="#181818" points="1197.9167,243.8477,1208.3333,248.0143,1197.9167,252.181,1202.0833,248.0143" style="stroke:#181818;stroke-width:1.0416666666666667;"/><line style="stroke:#181818;stroke-width:1.0416666666666667;" x1="195.8333" x2="1204.1667" y1="248.0143" y2="248.0143"/><text fill="#000000" font-family="sans-serif" font-size="13.5417" lengthAdjust="spacing" textLength="394.7917" x="203.125" y="242.7373">POST /_matrix/client/r0/user/{userId}/openid/request_token</text><polygon fill="#181818" points="207.2917,274.1943,196.875,278.361,207.2917,282.5277,203.125,278.361" style="stroke:#181818;stroke-width:1.0416666666666667;"/><line style="stroke:#181818;stroke-width:1.0416666666666667;stroke-dasharray:2.0,2.0;" x1="201.0417" x2="1214.5833" y1="278.361" y2="278.361"/><text fill="#000000" font-family="sans-serif" font-size="13.5417" lengthAdjust="spacing" textLength="750" x="213.5417" y="273.084">HTTP 200 OK, Result body {"access_token": "Matrix-OpenID-Token",..., "matrix_server_name": "example.com",...}</text><polygon fill="#181818" points="680.2083,304.541,690.625,308.7077,680.2083,312.8743,684.375,308.7077" style="stroke:#181818;stroke-width:1.0416666666666667;"/><line style="stroke:#181818;stroke-width:1.0416666666666667;" x1="195.8333" x2="686.4583" y1="308.7077" y2="308.7077"/><text fill="#000000" font-family="sans-serif" font-size="13.5417" lengthAdjust="spacing" textLength="427.0833" x="203.125" y="303.4307">GET /tim-authenticate... (Auth Header mit Matrix-OpenID-Token)</text><line style="stroke:#181818;stroke-width:1.0416666666666667;" x1="703.125" x2="746.875" y1="354.8177" y2="354.8177"/><line style="stroke:#181818;stroke-width:1.0416666666666667;" x1="746.875" x2="746.875" y1="354.8177" y2="368.3594"/><line style="stroke:#181818;stroke-width:1.0416666666666667;" x1="704.1667" x2="746.875" y1="368.3594" y2="368.3594"/><polygon fill="#181818" points="714.5833,364.1927,704.1667,368.3594,714.5833,372.526,710.4167,368.3594" style="stroke:#181818;stroke-width:1.0416666666666667;"/><text fill="#000000" font-family="sans-serif" font-size="13.5417" lengthAdjust="spacing" textLength="196.875" x="710.4167" y="333.7774">Prüfe ob matrix_server_name</text><text fill="#000000" font-family="sans-serif" font-size="13.5417" lengthAdjust="spacing" textLength="188.5417" x="710.4167" y="349.5407">in Föderationsliste enthalten</text><polygon fill="#181818" points="1197.9167,410.3027,1208.3333,414.4694,1197.9167,418.6361,1202.0833,414.4694" style="stroke:#181818;stroke-width:1.0416666666666667;"/><line style="stroke:#181818;stroke-width:1.0416666666666667;" x1="703.125" x2="1204.1667" y1="414.4694" y2="414.4694"/><text fill="#000000" font-family="sans-serif" font-size="13.5417" lengthAdjust="spacing" textLength="140.625" x="710.4167" y="393.4291">GET /openid/userinfo/</text><text fill="#000000" font-family="sans-serif" font-size="13.5417" lengthAdjust="spacing" textLength="395.8333" x="710.4167" y="409.1924">request header, Authorization: Bearer Matrix-OpenID-Token</text><polygon fill="#181818" points="714.5833,456.4128,704.1667,460.5794,714.5833,464.7461,710.4167,460.5794" style="stroke:#181818;stroke-width:1.0416666666666667;"/><line style="stroke:#181818;stroke-width:1.0416666666666667;stroke-dasharray:2.0,2.0;" x1="708.3333" x2="1214.5833" y1="460.5794" y2="460.5794"/><text fill="#000000" font-family="sans-serif" font-size="13.5417" lengthAdjust="spacing" textLength="85.4167" x="720.8333" y="439.5391">HTTP 200 OK</text><text fill="#000000" font-family="sans-serif" font-size="13.5417" lengthAdjust="spacing" textLength="210.4167" x="720.8333" y="455.3024">(Result Body MXID des Nutzers)</text><line style="stroke:#181818;stroke-width:1.0416666666666667;" x1="703.125" x2="746.875" y1="490.9261" y2="490.9261"/><line style="stroke:#181818;stroke-width:1.0416666666666667;" x1="746.875" x2="746.875" y1="490.9261" y2="504.4678"/><line style="stroke:#181818;stroke-width:1.0416666666666667;" x1="704.1667" x2="746.875" y1="504.4678" y2="504.4678"/><polygon fill="#181818" points="714.5833,500.3011,704.1667,504.4678,714.5833,508.6344,710.4167,504.4678" style="stroke:#181818;stroke-width:1.0416666666666667;"/><text fill="#000000" font-family="sans-serif" font-size="13.5417" lengthAdjust="spacing" textLength="348.9583" x="710.4167" y="485.6491">erzeuge search-accesstoken für TI-Messenger-Client</text><polygon fill="#181818" points="207.2917,562.1745,196.875,566.3411,207.2917,570.5078,203.125,566.3411" style="stroke:#181818;stroke-width:1.0416666666666667;"/><line style="stroke:#181818;stroke-width:1.0416666666666667;stroke-dasharray:2.0,2.0;" x1="201.0417" x2="696.875" y1="566.3411" y2="566.3411"/><text fill="#000000" font-family="sans-serif" font-size="13.5417" lengthAdjust="spacing" textLength="170.8333" x="213.5417" y="529.5375">HTTP 200 OK, Result body</text><text fill="#000000" font-family="sans-serif" font-size="13.5417" lengthAdjust="spacing" textLength="419.7917" x="213.5417" y="545.3008">{"access_token"="search-accesstoken", "token_type":"bearer",</text><text fill="#000000" font-family="sans-serif" font-size="13.5417" lengthAdjust="spacing" textLength="131.25" x="213.5417" y="561.0641">"expires_in":86400}</text><polygon fill="#181818" points="483.3333,615.5762,493.75,619.7428,483.3333,623.9095,487.5,619.7428" style="stroke:#181818;stroke-width:1.0416666666666667;"/><line style="stroke:#181818;stroke-width:1.0416666666666667;" x1="195.8333" x2="489.5833" y1="619.7428" y2="619.7428"/><text fill="#000000" font-family="sans-serif" font-size="13.5417" lengthAdjust="spacing" textLength="218.75" x="203.125" y="598.7025">GET /search?... (Auth Header mit</text><text fill="#000000" font-family="sans-serif" font-size="13.5417" lengthAdjust="spacing" textLength="138.5417" x="203.125" y="614.4658">search-accesstoken)</text><line style="stroke:#181818;stroke-width:1.0416666666666667;" x1="506.25" x2="550" y1="650.0895" y2="650.0895"/><line style="stroke:#181818;stroke-width:1.0416666666666667;" x1="550" x2="550" y1="650.0895" y2="663.6312"/><line style="stroke:#181818;stroke-width:1.0416666666666667;" x1="507.2917" x2="550" y1="663.6312" y2="663.6312"/><polygon fill="#181818" points="517.7083,659.4645,507.2917,663.6312,517.7083,667.7979,513.5417,663.6312" style="stroke:#181818;stroke-width:1.0416666666666667;"/><text fill="#000000" font-family="sans-serif" font-size="13.5417" lengthAdjust="spacing" textLength="171.875" x="513.5417" y="644.8125">prüfe search-accesstoken</text><path d="M100.5208,679.2562 L167.1875,679.2562 L167.1875,686.6862 L156.7708,697.1029 L100.5208,697.1029 L100.5208,679.2562 " fill="#EEEEEE" style="stroke:#000000;stroke-width:1.5625;"/><rect fill="none" height="170.4183" style="stroke:#000000;stroke-width:1.5625;" width="1040.1042" x="100.5208" y="679.2562"/><text fill="#000000" font-family="sans-serif" font-size="13.5417" font-weight="bold" lengthAdjust="spacing" textLength="19.7917" x="116.1458" y="692.8675">alt</text><text fill="#000000" font-family="sans-serif" font-size="11.4583" font-weight="bold" lengthAdjust="spacing" textLength="195.8333" x="182.8125" y="691.9754">[search-accesstoken is valid]</text><polygon fill="#181818" points="1054.1667,714.9495,1064.5833,719.1162,1054.1667,723.2829,1058.3333,719.1162" style="stroke:#181818;stroke-width:1.0416666666666667;"/><line style="stroke:#181818;stroke-width:1.0416666666666667;" x1="506.25" x2="1060.4167" y1="719.1162" y2="719.1162"/><text fill="#000000" font-family="sans-serif" font-size="13.5417" lengthAdjust="spacing" textLength="54.1667" x="513.5417" y="713.8392">GET /?...</text><polygon fill="#181818" points="517.7083,761.0596,507.2917,765.2262,517.7083,769.3929,513.5417,765.2262" style="stroke:#181818;stroke-width:1.0416666666666667;"/><line style="stroke:#181818;stroke-width:1.0416666666666667;stroke-dasharray:2.0,2.0;" x1="511.4583" x2="1070.8333" y1="765.2262" y2="765.2262"/><text fill="#000000" font-family="sans-serif" font-size="13.5417" lengthAdjust="spacing" textLength="85.4167" x="523.9583" y="744.1859">HTTP 200 OK</text><text fill="#000000" font-family="sans-serif" font-size="13.5417" lengthAdjust="spacing" textLength="119.7917" x="523.9583" y="759.9492">(Result Body json)</text><polygon fill="#181818" points="207.2917,791.4063,196.875,795.5729,207.2917,799.7396,203.125,795.5729" style="stroke:#181818;stroke-width:1.0416666666666667;"/><line style="stroke:#181818;stroke-width:1.0416666666666667;stroke-dasharray:2.0,2.0;" x1="201.0417" x2="494.7917" y1="795.5729" y2="795.5729"/><text fill="#000000" font-family="sans-serif" font-size="13.5417" lengthAdjust="spacing" textLength="209.375" x="213.5417" y="790.2959">HTTP 200 OK (Result Body json)</text><line style="stroke:#000000;stroke-width:1.0416666666666667;stroke-dasharray:2.0,2.0;" x1="100.5208" x2="1140.625" y1="804.9479" y2="804.9479"/><text fill="#000000" font-family="sans-serif" font-size="11.4583" font-weight="bold" lengthAdjust="spacing" textLength="208.3333" x="105.7292" y="815.5838">[search-accesstoken is invalid]</text><polygon fill="#181818" points="207.2917,837.1745,196.875,841.3411,207.2917,845.5078,203.125,841.3411" style="stroke:#181818;stroke-width:1.0416666666666667;"/><line style="stroke:#181818;stroke-width:1.0416666666666667;stroke-dasharray:2.0,2.0;" x1="201.0417" x2="500" y1="841.3411" y2="841.3411"/><text fill="#000000" font-family="sans-serif" font-size="13.5417" lengthAdjust="spacing" textLength="62.5" x="213.5417" y="836.0641">HTTP 401</text><!--MD5=[f06ed4f85c9a1c4ddbde23e88032067b]
@startuml SequenceDiagram.FHIR-Directory.search
skinparam dpi 100
skinparam WrapWidth 200
skinparam monochrome true

'title "FHIR-Directory, Sequenzdiagram search'
actor Nutzer
participant cl as "TI-Messenger-Client"
box <size:16>FHIR-Directory</size> #WhiteSmoke
  participant fp as "FHIR-Proxy"
  participant au as "Auth-Service"
  participant fd as "FHIR-Directory"
end box
participant hs as "Matrix-Homeserver\n(Messenger-Proxy)"
activate cl

Nutzer -> cl:gibt FHIR-\nSuchparameter ein
cl -> cl: prüfe ob noch gültiges search-accesstoken\nvom FHIR-Directory Auth-Service vorliegt

alt kein gültiges search-accesstoken vorhanden
cl -> hs: POST /_matrix/client/r0/user/{userId}/openid/request_token
activate hs
hs - -> cl: HTTP 200 OK, Result body {"access_token": "Matrix-OpenID-Token",..., "matrix_server_name": "example.com",...}
deactivate hs
cl -> au: GET /tim-authenticate... (Auth Header mit Matrix-OpenID-Token)
activate au
au -> au: Prüfe ob matrix_server_name\nin Föderationsliste enthalten
au -> hs: GET /openid/userinfo/\nrequest header, Authorization: Bearer Matrix-OpenID-Token
activate hs
hs - -> au: HTTP 200 OK\n(Result Body MXID des Nutzers)
deactivate hs
au -> au: erzeuge search-accesstoken für TI-Messenger-Client
au - -> cl: HTTP 200 OK, Result body\n{"access_token"="search-accesstoken", "token_type":"bearer",\n"expires_in":86400}
deactivate au
end

cl -> fp: GET /search?... (Auth Header mit\nsearch-accesstoken)
activate fp
fp -> fp: prüfe search-accesstoken

alt search-accesstoken is valid
fp -> fd: GET /?...
activate fd
fd - -> fp: HTTP 200 OK\n(Result Body json)
deactivate fd
fp - -> cl: HTTP 200 OK (Result Body json)
else search-accesstoken is invalid
fp - -> cl: HTTP 401
deactivate fp
end

deactivate cl
@enduml

@startuml SequenceDiagram.FHIR-Directory.search
skinparam dpi 100
skinparam WrapWidth 200
skinparam monochrome true

actor Nutzer
participant cl as "TI-Messenger-Client"
box <size:16>FHIR-Directory</size> #WhiteSmoke
  participant fp as "FHIR-Proxy"
  participant au as "Auth-Service"
  participant fd as "FHIR-Directory"
end box
participant hs as "Matrix-Homeserver\n(Messenger-Proxy)"
activate cl

Nutzer -> cl:gibt FHIR-\nSuchparameter ein
cl -> cl: prüfe ob noch gültiges search-accesstoken\nvom FHIR-Directory Auth-Service vorliegt

alt kein gültiges search-accesstoken vorhanden
cl -> hs: POST /_matrix/client/r0/user/{userId}/openid/request_token
activate hs
hs - -> cl: HTTP 200 OK, Result body {"access_token": "Matrix-OpenID-Token",..., "matrix_server_name": "example.com",...}
deactivate hs
cl -> au: GET /tim-authenticate... (Auth Header mit Matrix-OpenID-Token)
activate au
au -> au: Prüfe ob matrix_server_name\nin Föderationsliste enthalten
au -> hs: GET /openid/userinfo/\nrequest header, Authorization: Bearer Matrix-OpenID-Token
activate hs
hs - -> au: HTTP 200 OK\n(Result Body MXID des Nutzers)
deactivate hs
au -> au: erzeuge search-accesstoken für TI-Messenger-Client
au - -> cl: HTTP 200 OK, Result body\n{"access_token"="search-accesstoken", "token_type":"bearer",\n"expires_in":86400}
deactivate au
end

cl -> fp: GET /search?... (Auth Header mit\nsearch-accesstoken)
activate fp
fp -> fp: prüfe search-accesstoken

alt search-accesstoken is valid
fp -> fd: GET /?...
activate fd
fd - -> fp: HTTP 200 OK\n(Result Body json)
deactivate fd
fp - -> cl: HTTP 200 OK (Result Body json)
else search-accesstoken is invalid
fp - -> cl: HTTP 401
deactivate fp
end

deactivate cl
@enduml

PlantUML version 1.2022.5(Sat Apr 30 10:55:52 UTC 2022)
(GPL source distribution)
Java Runtime: OpenJDK Runtime Environment
JVM: OpenJDK 64-Bit Server VM
Default Encoding: UTF-8
Language: en
Country: null
--></g></svg>